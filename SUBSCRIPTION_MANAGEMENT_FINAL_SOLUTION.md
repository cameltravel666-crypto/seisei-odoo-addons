# ğŸ¯ Seisei BizNexus è®¢é˜…ç®¡ç†å®Œæ•´æ–¹æ¡ˆ

**æ—¥æœŸ**: 2026-01-11  
**åŸºäº**: å®é™…åŒæœåŠ¡å™¨ç¯å¢ƒ

---

## ğŸ“Š å®é™…ç¯å¢ƒæ¶æ„

### æœåŠ¡å™¨é…ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Seisei BizNexus (Next.js + Capacitor)                       â”‚
â”‚  https://biznexus.seisei.tokyo                               â”‚
â”‚  - å‰ç«¯åº”ç”¨ï¼ˆiOS/Android/Webï¼‰                                 â”‚
â”‚  - ç§Ÿæˆ·ç®¡ç†ã€ç”¨æˆ·è®¤è¯                                           â”‚
â”‚  - è®¢é˜…çŠ¶æ€å±•ç¤º                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ RPC API              â†“ RPC API              â†“ Prisma
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Odoo 19  â”‚          â”‚ Odoo 18  â”‚          â”‚PostgreSQLâ”‚
    â”‚ ä¼ä¸šç‰ˆ    â”‚          â”‚ ç¤¾åŒºç‰ˆ    â”‚          â”‚ (Prisma) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœåŠ¡å™¨ 1: Odoo 19 ä¼ä¸šç‰ˆï¼ˆè®¢é˜…ç®¡ç†ï¼‰

| é¡¹ç›® | å€¼ |
|------|-----|
| **IP åœ°å€** | 13.159.193.191 |
| **ç«¯å£** | 8069 |
| **è®¿é—®åœ°å€** | http://13.159.193.191:8069/odoo |
| **æ•°æ®åº“** | ERP |
| **ç‰ˆæœ¬** | Odoo 19 ä¼ä¸šç‰ˆ |
| **SSH Key** | `/Users/taozhang/Projects/Pem/odoo 19 owner Server.pem` |
| **SSH ç”¨æˆ·** | ubuntu |
| **ç”¨é€”** | **è®¢é˜…ç®¡ç†**ï¼ˆsubscription, invoice, paymentï¼‰ |

### æœåŠ¡å™¨ 2: Odoo 18 ç¤¾åŒºç‰ˆï¼ˆä¸šåŠ¡æ•°æ®ï¼‰

| é¡¹ç›® | å€¼ |
|------|-----|
| **IP åœ°å€** | 54.65.127.141 |
| **ç«¯å£** | 8069 |
| **è®¿é—®åœ°å€** | http://54.65.127.141:8069 |
| **æ•°æ®åº“** | test001, odoo ç­‰ |
| **ç‰ˆæœ¬** | Odoo 18 ç¤¾åŒºç‰ˆ |
| **SSH Key** | `~/Projects/Pem/odoo-2025.pem` |
| **SSH ç”¨æˆ·** | ubuntu |
| **ç”¨é€”** | **ä¸šåŠ¡æ•°æ®**ï¼ˆPOS, Inventory, CRM, Sales ç­‰ï¼‰ |

### æœåŠ¡å™¨ 3: Seisei BizNexus (Next.js)

| é¡¹ç›® | å€¼ |
|------|-----|
| **IP åœ°å€** | 54.65.127.141 (ä¸ Odoo 18 åŒæœåŠ¡å™¨) |
| **ç«¯å£** | 3000 |
| **è®¿é—®åœ°å€** | https://biznexus.seisei.tokyo |
| **æ•°æ®åº“** | PostgreSQL (Prisma) |
| **ç”¨é€”** | **å‰ç«¯åº”ç”¨ + ç§Ÿæˆ·ç®¡ç†** |

---

## ğŸ¯ è®¢é˜…ç®¡ç†ç­–ç•¥

### æ ¸å¿ƒç†å¿µ

```
è®¢é˜…ä¿¡æ¯ = Odoo 19 (æƒå¨æº) + PostgreSQL (æœ¬åœ°ç¼“å­˜)
ä¸šåŠ¡æ•°æ® = Odoo 18
ç”¨æˆ·ç•Œé¢ = Seisei BizNexus
```

### æ•°æ®æµ

```
1. åˆ›å»ºè®¢é˜…:
   BizNexus â†’ Odoo 19 (åˆ›å»ºè®¢é˜…) â†’ PostgreSQL (ç¼“å­˜)

2. è®¡è´¹:
   Odoo 19 (ç”Ÿæˆå‘ç¥¨) â†’ BizNexus (é€šçŸ¥) â†’ PostgreSQL (æ›´æ–°)

3. åŠŸèƒ½æƒé™:
   BizNexus â†’ PostgreSQL (TenantFeature) â†’ Odoo 18 (ä¸šåŠ¡æ•°æ®)
```

---

## ğŸ”§ Step 1: åœ¨ Odoo 19 ä¸Šé…ç½®è®¢é˜…ç®¡ç†

### 1.1 å®‰è£…è®¢é˜…æ¨¡å—

```bash
# SSH è¿æ¥åˆ° Odoo 19 æœåŠ¡å™¨
ssh -i "/Users/taozhang/Projects/Pem/odoo 19 owner Server.pem" ubuntu@13.159.193.191

# ç¡®è®¤ Odoo è¿è¡Œæ–¹å¼
sudo docker ps | grep odoo || sudo systemctl status odoo

# è¿›å…¥ Odoo å®¹å™¨ï¼ˆå¦‚æœæ˜¯ Dockerï¼‰
sudo docker exec -it <container_name> bash

# æˆ–è€…ç›´æ¥åœ¨æœåŠ¡å™¨æ‰§è¡Œï¼ˆå¦‚æœæ˜¯ systemdï¼‰
# ä»¥ä¸‹æ­¥éª¤åœ¨ Odoo Web UI å®Œæˆæ›´å®‰å…¨
```

**åœ¨ Odoo 19 Web UI ä¸­**ï¼š
1. è®¿é—® http://13.159.193.191:8069/odoo
2. ç™»å½•åˆ° `ERP` æ•°æ®åº“
3. Apps â†’ æœç´¢ `Subscriptions`
4. å®‰è£…ä»¥ä¸‹æ¨¡å—ï¼š
   - âœ… `sale_subscription` - è®¢é˜…ç®¡ç†æ ¸å¿ƒ
   - âœ… `sale` - é”€å”®è®¢å•
   - âœ… `account` - ä¼šè®¡/å‘ç¥¨
   - âœ… `payment` - æ”¯ä»˜å¤„ç†

### 1.2 åˆ›å»ºè®¢é˜…äº§å“

åœ¨ Odoo 19 ä¸­ï¼š**Subscriptions â†’ Configuration â†’ Subscription Products**

åˆ›å»º 3 ä¸ªè®¢é˜…äº§å“ï¼š

#### äº§å“ 1: BizNexus Basic

```
äº§å“åç§°: BizNexus Basic Plan
äº§å“ç±»å‹: Service
è®¡è´¹å‘¨æœŸ: Monthly (1 month)
ä»·æ ¼: Â¥5,000
å…è®¸çš„æ¨¡å—:
  - DASHBOARD
  - POS
```

#### äº§å“ 2: BizNexus Standard

```
äº§å“åç§°: BizNexus Standard Plan
äº§å“ç±»å‹: Service
è®¡è´¹å‘¨æœŸ: Monthly (1 month)
ä»·æ ¼: Â¥15,000
å…è®¸çš„æ¨¡å—:
  - DASHBOARD
  - POS
  - INVENTORY
  - PURCHASE
  - SALES
  - CRM
```

#### äº§å“ 3: BizNexus Premium

```
äº§å“åç§°: BizNexus Premium Plan
äº§å“ç±»å‹: Service
è®¡è´¹å‘¨æœŸ: Monthly (1 month)
ä»·æ ¼: Â¥30,000
å…è®¸çš„æ¨¡å—:
  - ALL_MODULES
```

### 1.3 é…ç½®æ”¯ä»˜æ–¹å¼

**Accounting â†’ Configuration â†’ Payment Providers**

é…ç½®æ—¥æœ¬å¸¸ç”¨æ”¯ä»˜æ–¹å¼ï¼š
- é“¶è¡Œè½¬è´¦
- ä¿¡ç”¨å¡ï¼ˆStripeï¼‰
- PayPayï¼ˆå¦‚éœ€è¦ï¼‰

---

## ğŸ”§ Step 2: æ›´æ–° Seisei BizNexus ç¯å¢ƒé…ç½®

### 2.1 æ›´æ–° .env æ–‡ä»¶

```bash
cd /opt/seisei-erp

# å¤‡ä»½ç°æœ‰ .env
sudo cp .env .env.backup.$(date +%Y%m%d_%H%M%S)

# æ·»åŠ  Odoo 19 é…ç½®
sudo bash -c 'cat >> .env << EOF

# ================================
# Odoo 19 Subscription Management
# ================================
ODOO19_URL="http://13.159.193.191:8069"
ODOO19_DB="ERP"
ODOO19_USERNAME="admin"
ODOO19_PASSWORD="<your_password>"

# ================================
# Odoo 18 Business Data (å·²å­˜åœ¨)
# ================================
ODOO_URL="http://10.0.1.184:8069"
ODOO_DB="test001"
ODOO_USERNAME="admin"
ODOO_PASSWORD="admin"

# ================================
# Cron Job Secret
# ================================
CRON_SECRET="<generate_random_secret_here>"
EOF'

# é‡å¯æœåŠ¡åº”ç”¨æ–°é…ç½®
cd /opt/seisei-erp
sudo docker compose down
sudo docker compose up -d
```

### 2.2 åœ¨ Next.js ä¸­æ·»åŠ  Odoo 19 å®¢æˆ·ç«¯

```bash
# åœ¨æœ¬åœ°å¼€å‘
cd /Users/taozhang/Projects/Seisei\ ERP
```

åˆ›å»ºæ–‡ä»¶ï¼š`src/lib/odoo19.ts`

```typescript
/**
 * Odoo 19 RPC Client for Subscription Management
 */

import { OdooRPC } from './odoo-rpc';

export class Odoo19Client {
  private client: OdooRPC;
  private authenticated = false;

  constructor() {
    this.client = new OdooRPC({
      baseUrl: process.env.ODOO19_URL || 'http://13.159.193.191:8069',
      db: process.env.ODOO19_DB || 'ERP',
      username: process.env.ODOO19_USERNAME || 'admin',
      password: process.env.ODOO19_PASSWORD || '',
    });
  }

  private async ensureAuth() {
    if (!this.authenticated) {
      await this.client.authenticate();
      this.authenticated = true;
    }
  }

  /**
   * åˆ›å»ºæˆ–è·å–å®¢æˆ· (Partner)
   */
  async createOrGetPartner(tenantData: {
    name: string;
    email?: string;
    phone?: string;
  }): Promise<number> {
    await this.ensureAuth();

    // æŸ¥æ‰¾ç°æœ‰å®¢æˆ·
    const partnerIds = await this.client.search('res.partner', [
      ['name', '=', tenantData.name],
    ]);

    if (partnerIds.length > 0) {
      return partnerIds[0];
    }

    // åˆ›å»ºæ–°å®¢æˆ·
    return await this.client.create('res.partner', {
      name: tenantData.name,
      email: tenantData.email,
      phone: tenantData.phone,
      is_company: true,
      customer_rank: 1,
    });
  }

  /**
   * åˆ›å»ºè®¢é˜…
   */
  async createSubscription(params: {
    partnerId: number;
    productId: number;
    startDate: Date;
    trialDays?: number;
  }): Promise<number> {
    await this.ensureAuth();

    const nextInvoiceDate = new Date(params.startDate);
    if (params.trialDays) {
      nextInvoiceDate.setDate(nextInvoiceDate.getDate() + params.trialDays);
    } else {
      nextInvoiceDate.setMonth(nextInvoiceDate.getMonth() + 1);
    }

    // åˆ›å»ºé”€å”®è®¢å•ï¼ˆè®¢é˜…ç±»å‹ï¼‰
    const orderId = await this.client.create('sale.order', {
      partner_id: params.partnerId,
      state: 'draft',
      order_line: [[0, 0, {
        product_id: params.productId,
        product_uom_qty: 1,
      }]],
    });

    // ç¡®è®¤è®¢å•
    await this.client.callKw('sale.order', 'action_confirm', [[orderId]]);

    return orderId;
  }

  /**
   * è·å–è®¢é˜…åˆ—è¡¨
   */
  async getSubscriptions(partnerId: number) {
    await this.ensureAuth();

    const subscriptions = await this.client.searchRead(
      'sale.order',
      [
        ['partner_id', '=', partnerId],
        ['state', '!=', 'cancel'],
      ],
      ['name', 'date_order', 'amount_total', 'state', 'invoice_status']
    );

    return subscriptions;
  }

  /**
   * è·å–è®¢é˜…äº§å“åˆ—è¡¨
   */
  async getSubscriptionProducts() {
    await this.ensureAuth();

    const products = await this.client.searchRead(
      'product.template',
      [
        ['name', 'ilike', 'BizNexus'],
        ['type', '=', 'service'],
      ],
      ['id', 'name', 'list_price', 'description']
    );

    return products;
  }

  /**
   * ç”Ÿæˆå‘ç¥¨
   */
  async createInvoice(orderId: number): Promise<number> {
    await this.ensureAuth();

    // è°ƒç”¨è®¢å•çš„åˆ›å»ºå‘ç¥¨æ–¹æ³•
    const result = await this.client.callKw(
      'sale.order',
      'action_invoice_create',
      [[orderId]]
    );

    return Array.isArray(result) ? result[0] : result;
  }

  /**
   * è·å–å‘ç¥¨ä¿¡æ¯
   */
  async getInvoice(invoiceId: number) {
    await this.ensureAuth();

    const invoices = await this.client.searchRead(
      'account.move',
      [['id', '=', invoiceId]],
      [
        'name',
        'partner_id',
        'invoice_date',
        'invoice_date_due',
        'amount_total',
        'amount_residual',
        'state',
        'payment_state',
      ]
    );

    return invoices[0];
  }

  /**
   * è®°å½•æ”¯ä»˜
   */
  async registerPayment(params: {
    invoiceId: number;
    amount: number;
    paymentDate: Date;
    journalId: number;
  }): Promise<number> {
    await this.ensureAuth();

    const paymentId = await this.client.create('account.payment', {
      payment_type: 'inbound',
      partner_type: 'customer',
      amount: params.amount,
      date: params.paymentDate.toISOString().split('T')[0],
      journal_id: params.journalId,
    });

    // å‘å¸ƒæ”¯ä»˜
    await this.client.callKw('account.payment', 'action_post', [[paymentId]]);

    return paymentId;
  }

  /**
   * å–æ¶ˆè®¢é˜…
   */
  async cancelSubscription(orderId: number): Promise<void> {
    await this.ensureAuth();

    await this.client.callKw('sale.order', 'action_cancel', [[orderId]]);
  }
}

// å¯¼å‡ºå•ä¾‹
export const odoo19 = new Odoo19Client();
```

---

## ğŸ”§ Step 3: æ›´æ–° Prisma Schema

åœ¨ `prisma/schema.prisma` ä¸­æ·»åŠ ï¼š

```prisma
// ============================================
// è®¢é˜…ç®¡ç†ï¼ˆä¸ Odoo 19 åŒæ­¥ï¼‰
// ============================================

model Subscription {
  id                String   @id @default(cuid())
  tenantId          String   @map("tenant_id")
  planCode          String   @map("plan_code")
  
  // Odoo 19 é›†æˆ
  odoo19OrderId        Int?     @map("odoo19_order_id")
  odoo19PartnerId      Int?     @map("odoo19_partner_id")
  odoo19ProductId      Int?     @map("odoo19_product_id")
  
  // è®¢é˜…çŠ¶æ€
  status            SubscriptionStatus @default(ACTIVE)
  startDate         DateTime @map("start_date")
  nextBillingDate   DateTime @map("next_billing_date")
  endDate           DateTime? @map("end_date")
  
  // è®¡è´¹ä¿¡æ¯
  billingCycle      BillingCycle @default(MONTHLY)
  amount            Decimal
  currency          String @default("JPY")
  autoRenew         Boolean @default(true) @map("auto_renew")
  
  // è¯•ç”¨æœŸ
  trialEndDate      DateTime? @map("trial_end_date")
  isInTrial         Boolean @default(false) @map("is_in_trial")
  
  // æœ€ååŒæ­¥æ—¶é—´
  lastSyncAt        DateTime @default(now()) @map("last_sync_at")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  tenant            Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan              SubscriptionPlan @relation(fields: [planCode], references: [planCode])
  invoices          Invoice[]

  @@map("subscriptions")
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  YEARLY
}

model Invoice {
  id                 String   @id @default(cuid())
  subscriptionId     String   @map("subscription_id")
  tenantId           String   @map("tenant_id")
  
  // Odoo 19 å‘ç¥¨ ID
  odoo19InvoiceId    Int?     @map("odoo19_invoice_id")
  
  invoiceNumber      String   @unique @map("invoice_number")
  amount             Decimal
  currency           String @default("JPY")
  status             InvoiceStatus @default(DRAFT)
  
  issueDate          DateTime @map("issue_date")
  dueDate            DateTime @map("due_date")
  paidDate           DateTime? @map("paid_date")
  
  periodStart        DateTime @map("period_start")
  periodEnd          DateTime @map("period_end")
  
  // æœ€ååŒæ­¥æ—¶é—´
  lastSyncAt        DateTime @default(now()) @map("last_sync_at")
  
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  subscription       Subscription @relation(fields: [subscriptionId], references: [id])
  payments           Payment[]

  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

model Payment {
  id                 String   @id @default(cuid())
  invoiceId          String   @map("invoice_id")
  tenantId           String   @map("tenant_id")
  
  // Odoo 19 æ”¯ä»˜ ID
  odoo19PaymentId    Int?     @map("odoo19_payment_id")
  
  amount             Decimal
  currency           String @default("JPY")
  paymentMethod      PaymentMethod @map("payment_method")
  status             PaymentStatus @default(PENDING)
  
  gatewayProvider    String?  @map("gateway_provider")
  gatewayTransactionId String? @map("gateway_transaction_id")
  
  paymentDate        DateTime? @map("payment_date")
  
  // æœ€ååŒæ­¥æ—¶é—´
  lastSyncAt        DateTime @default(now()) @map("last_sync_at")
  
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  invoice            Invoice @relation(fields: [invoiceId], references: [id])

  @@map("payments")
}

enum PaymentMethod {
  CREDIT_CARD
  BANK_TRANSFER
  KONBINI
  PAYPAY
  OTHER
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

// æ›´æ–° Tenant æ¨¡å‹
model Tenant {
  // ... ç°æœ‰å­—æ®µ ...
  subscriptions     Subscription[]
}

// æ›´æ–° SubscriptionPlan æ¨¡å‹
model SubscriptionPlan {
  // ... ç°æœ‰å­—æ®µ ...
  odoo19ProductId   Int?     @map("odoo19_product_id")
  trialDays         Int      @default(14) @map("trial_days")
  subscriptions     Subscription[]
}
```

---

## ğŸ”§ Step 4: æ•°æ®åº“è¿ç§»

```bash
# åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ
cd /Users/taozhang/Projects/Seisei\ ERP

# ç”Ÿæˆè¿ç§»
npx prisma migrate dev --name add_subscription_management

# éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
cd /opt/seisei-erp
sudo npx prisma migrate deploy
sudo npx prisma generate
```

---

## ğŸ”§ Step 5: åˆ›å»ºè®¢é˜…ç®¡ç† API

åˆ›å»ºæ–‡ä»¶ï¼š`src/app/api/subscriptions/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getSession } from '@/lib/auth';
import { prisma } from '@/lib/db';
import { odoo19 } from '@/lib/odoo19';

/**
 * GET /api/subscriptions
 * è·å–å½“å‰ç§Ÿæˆ·çš„è®¢é˜…ä¿¡æ¯
 */
export async function GET(request: NextRequest) {
  try {
    const session = await getSession();
    if (!session) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // ä» PostgreSQL è·å–ç¼“å­˜çš„è®¢é˜…ä¿¡æ¯
    const subscription = await prisma.subscription.findFirst({
      where: {
        tenantId: session.tenantId,
        status: { in: ['TRIAL', 'ACTIVE'] },
      },
      include: {
        plan: true,
        invoices: {
          orderBy: { issueDate: 'desc' },
          take: 10,
        },
      },
    });

    if (!subscription) {
      return NextResponse.json({ error: 'No active subscription' }, { status: 404 });
    }

    // å¦‚æœè¶…è¿‡ 5 åˆ†é’ŸæœªåŒæ­¥ï¼Œä» Odoo 19 åŒæ­¥æœ€æ–°çŠ¶æ€
    const shouldSync = Date.now() - subscription.lastSyncAt.getTime() > 5 * 60 * 1000;
    
    if (shouldSync && subscription.odoo19OrderId) {
      try {
        const odooOrders = await odoo19.getSubscriptions(subscription.odoo19PartnerId!);
        const odooOrder = odooOrders.find(o => o.id === subscription.odoo19OrderId);

        if (odooOrder) {
          // æ›´æ–°è®¢é˜…çŠ¶æ€
          await prisma.subscription.update({
            where: { id: subscription.id },
            data: {
              status: odooOrder.state === 'cancel' ? 'CANCELLED' : subscription.status,
              amount: odooOrder.amount_total,
              lastSyncAt: new Date(),
            },
          });
        }
      } catch (syncError) {
        console.error('[Subscription Sync Error]', syncError);
        // å³ä½¿åŒæ­¥å¤±è´¥ï¼Œä¹Ÿè¿”å›ç¼“å­˜çš„æ•°æ®
      }
    }

    return NextResponse.json(subscription);
  } catch (error) {
    console.error('[Subscription API]', error);
    return NextResponse.json(
      { error: 'Failed to fetch subscription' },
      { status: 500 }
    );
  }
}

/**
 * POST /api/subscriptions
 * åˆ›å»ºæ–°è®¢é˜…
 */
export async function POST(request: NextRequest) {
  try {
    const session = await getSession();
    if (!session || !session.user.isAdmin) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { planCode, startTrial } = await request.json();

    const tenant = await prisma.tenant.findUnique({
      where: { id: session.tenantId },
    });

    const plan = await prisma.subscriptionPlan.findUnique({
      where: { planCode },
    });

    if (!tenant || !plan || !plan.odoo19ProductId) {
      return NextResponse.json({ error: 'Invalid request' }, { status: 400 });
    }

    // 1. åœ¨ Odoo 19 åˆ›å»ºå®¢æˆ·
    const partnerId = await odoo19.createOrGetPartner({
      name: tenant.name,
    });

    // 2. åœ¨ Odoo 19 åˆ›å»ºè®¢é˜…
    const startDate = new Date();
    const trialDays = startTrial ? plan.trialDays : 0;
    
    const odoo19OrderId = await odoo19.createSubscription({
      partnerId,
      productId: plan.odoo19ProductId,
      startDate,
      trialDays,
    });

    // 3. åœ¨ PostgreSQL åˆ›å»ºè®¢é˜…è®°å½•
    const trialEndDate = startTrial
      ? new Date(Date.now() + plan.trialDays * 24 * 60 * 60 * 1000)
      : null;
    const nextBillingDate = trialEndDate || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);

    const subscription = await prisma.subscription.create({
      data: {
        tenantId: tenant.id,
        planCode: plan.planCode,
        odoo19OrderId,
        odoo19PartnerId: partnerId,
        odoo19ProductId: plan.odoo19ProductId,
        status: startTrial ? 'TRIAL' : 'ACTIVE',
        startDate,
        nextBillingDate,
        trialEndDate,
        isInTrial: !!startTrial,
        billingCycle: plan.billingCycle || 'MONTHLY',
        amount: plan.priceMonthly,
        currency: 'JPY',
      },
    });

    // 4. åˆå§‹åŒ–ç§Ÿæˆ·åŠŸèƒ½
    await prisma.tenantFeature.createMany({
      data: plan.allowedModules.map(moduleCode => ({
        tenantId: tenant.id,
        moduleCode: moduleCode as any,
        isAllowed: true,
        isVisible: true,
      })),
      skipDuplicates: true,
    });

    return NextResponse.json(subscription);
  } catch (error) {
    console.error('[Create Subscription]', error);
    return NextResponse.json(
      { error: 'Failed to create subscription' },
      { status: 500 }
    );
  }
}
```

---

## ğŸ”§ Step 6: åˆå§‹åŒ–è®¢é˜…äº§å“æ•°æ®

åˆ›å»ºç§å­è„šæœ¬ï¼š`prisma/seed/subscription-plans.ts`

```typescript
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function seedSubscriptionPlans() {
  console.log('ğŸŒ± Seeding subscription plans...');

  const plans = [
    {
      planCode: 'basic',
      name: 'BizNexus Basic',
      allowedModules: ['DASHBOARD', 'POS'],
      maxUsers: 3,
      priceMonthly: 5000,
      trialDays: 14,
      billingCycle: 'MONTHLY' as const,
      isActive: true,
      // åœ¨ Odoo 19 ä¸­åˆ›å»ºäº§å“åï¼Œæ‰‹åŠ¨æ›´æ–°è¿™ä¸ª ID
      odoo19ProductId: null, // TODO: ä» Odoo 19 è·å–äº§å“ ID
    },
    {
      planCode: 'standard',
      name: 'BizNexus Standard',
      allowedModules: ['DASHBOARD', 'POS', 'INVENTORY', 'PURCHASE', 'SALES', 'CRM'],
      maxUsers: 10,
      priceMonthly: 15000,
      trialDays: 14,
      billingCycle: 'MONTHLY' as const,
      isActive: true,
      odoo19ProductId: null, // TODO: ä» Odoo 19 è·å–äº§å“ ID
    },
    {
      planCode: 'premium',
      name: 'BizNexus Premium',
      allowedModules: [
        'DASHBOARD', 'POS', 'INVENTORY', 'PURCHASE', 'SALES', 'CRM',
        'ACCOUNTING', 'FINANCE', 'HR', 'DOCUMENTS', 'MAINTENANCE', 'APPROVALS'
      ],
      maxUsers: 50,
      priceMonthly: 30000,
      trialDays: 14,
      billingCycle: 'MONTHLY' as const,
      isActive: true,
      odoo19ProductId: null, // TODO: ä» Odoo 19 è·å–äº§å“ ID
    },
  ];

  for (const plan of plans) {
    await prisma.subscriptionPlan.upsert({
      where: { planCode: plan.planCode },
      update: plan,
      create: plan,
    });
    console.log(`  âœ… ${plan.name}`);
  }

  console.log('âœ… Subscription plans seeded');
}

seedSubscriptionPlans()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

è¿è¡Œç§å­è„šæœ¬ï¼š

```bash
cd /Users/taozhang/Projects/Seisei\ ERP
npx tsx prisma/seed/subscription-plans.ts
```

---

## ğŸ”§ Step 7: è·å– Odoo 19 äº§å“ ID å¹¶æ›´æ–°

åˆ›å»ºè¾…åŠ©è„šæœ¬ï¼š`scripts/sync-odoo19-products.ts`

```typescript
import { PrismaClient } from '@prisma/client';
import { odoo19 } from '../src/lib/odoo19';

const prisma = new PrismaClient();

async function syncOdoo19Products() {
  console.log('ğŸ”„ Syncing Odoo 19 product IDs...');

  const products = await odoo19.getSubscriptionProducts();

  console.log(`Found ${products.length} subscription products in Odoo 19:`);
  products.forEach(p => console.log(`  - ${p.name} (ID: ${p.id})`));

  // æ‰‹åŠ¨æ˜ å°„äº§å“ ID
  const mapping = {
    'BizNexus Basic Plan': 'basic',
    'BizNexus Standard Plan': 'standard',
    'BizNexus Premium Plan': 'premium',
  };

  for (const product of products) {
    const planCode = mapping[product.name as keyof typeof mapping];
    if (planCode) {
      await prisma.subscriptionPlan.update({
        where: { planCode },
        data: { odoo19ProductId: product.id },
      });
      console.log(`  âœ… Updated ${planCode} with Odoo 19 Product ID: ${product.id}`);
    }
  }

  console.log('âœ… Sync complete');
}

syncOdoo19Products()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

---

## ğŸ”§ Step 8: å‰ç«¯è®¢é˜…ç®¡ç†é¡µé¢

åˆ›å»ºæ–‡ä»¶ï¼š`src/app/(app)/settings/subscription/page.tsx`

```typescript
'use client';

import { useEffect, useState } from 'react';
import { useTranslations } from 'next-intl';
import { Card } from '@/components/ui/card';

interface Subscription {
  id: string;
  status: string;
  amount: number;
  nextBillingDate: string;
  isInTrial: boolean;
  trialEndDate?: string;
  plan: {
    name: string;
    planCode: string;
  };
  invoices: Array<{
    id: string;
    invoiceNumber: string;
    amount: number;
    issueDate: string;
    status: string;
  }>;
}

export default function SubscriptionPage() {
  const t = useTranslations();
  const [subscription, setSubscription] = useState<Subscription | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch('/api/subscriptions')
      .then(res => res.json())
      .then(data => {
        setSubscription(data);
        setLoading(false);
      })
      .catch(err => {
        console.error(err);
        setLoading(false);
      });
  }, []);

  if (loading) {
    return (
      <div className="flex items-center justify-center h-96">
        <div className="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    );
  }

  if (!subscription) {
    return (
      <div className="max-w-4xl mx-auto">
        <Card className="p-8 text-center">
          <h2 className="text-xl font-bold mb-4">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</h2>
          <button className="px-4 py-2 bg-blue-600 text-white rounded">
            ãƒ—ãƒ©ãƒ³ã‚’é¸æŠ
          </button>
        </Card>
      </div>
    );
  }

  const getStatusBadge = (status: string) => {
    const badges = {
      ACTIVE: { label: 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', class: 'bg-green-100 text-green-800' },
      TRIAL: { label: 'è©¦ç”¨ä¸­', class: 'bg-blue-100 text-blue-800' },
      PAST_DUE: { label: 'æ”¯æ‰•æœŸé™è¶…é', class: 'bg-red-100 text-red-800' },
      CANCELLED: { label: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿', class: 'bg-gray-100 text-gray-800' },
    };
    const badge = badges[status as keyof typeof badges] || badges.ACTIVE;
    return (
      <span className={`px-3 py-1 rounded-full text-sm font-medium ${badge.class}`}>
        {badge.label}
      </span>
    );
  };

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      <h1 className="text-2xl font-bold">ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†</h1>

      {/* ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ */}
      <Card className="p-6">
        <div className="flex justify-between items-start mb-4">
          <h2 className="text-lg font-semibold">ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³</h2>
          {getStatusBadge(subscription.status)}
        </div>

        <div className="grid grid-cols-2 gap-4 mb-4">
          <div>
            <p className="text-sm text-gray-500">ãƒ—ãƒ©ãƒ³å</p>
            <p className="font-medium">{subscription.plan.name}</p>
          </div>
          <div>
            <p className="text-sm text-gray-500">æœˆé¡æ–™é‡‘</p>
            <p className="font-medium">Â¥{subscription.amount.toLocaleString()}</p>
          </div>
          <div>
            <p className="text-sm text-gray-500">æ¬¡å›è«‹æ±‚æ—¥</p>
            <p className="font-medium">
              {new Date(subscription.nextBillingDate).toLocaleDateString('ja-JP')}
            </p>
          </div>
          <div>
            <p className="text-sm text-gray-500">ãƒ—ãƒ©ãƒ³ã‚³ãƒ¼ãƒ‰</p>
            <p className="font-medium uppercase">{subscription.plan.planCode}</p>
          </div>
        </div>

        {subscription.isInTrial && subscription.trialEndDate && (
          <div className="p-3 bg-blue-50 rounded-lg">
            <p className="text-sm text-blue-800">
              â° è©¦ç”¨æœŸé–“ã¯ {new Date(subscription.trialEndDate).toLocaleDateString('ja-JP')} ã¾ã§
            </p>
          </div>
        )}
      </Card>

      {/* è«‹æ±‚å±¥æ­´ */}
      <Card className="p-6">
        <h2 className="text-lg font-semibold mb-4">è«‹æ±‚å±¥æ­´</h2>
        {subscription.invoices.length === 0 ? (
          <p className="text-gray-500">è«‹æ±‚å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>
        ) : (
          <div className="space-y-2">
            {subscription.invoices.map((invoice) => (
              <div
                key={invoice.id}
                className="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
              >
                <div>
                  <p className="font-medium">{invoice.invoiceNumber}</p>
                  <p className="text-sm text-gray-500">
                    {new Date(invoice.issueDate).toLocaleDateString('ja-JP')}
                  </p>
                </div>
                <div className="text-right">
                  <p className="font-medium">Â¥{invoice.amount.toLocaleString()}</p>
                  <p className="text-sm">
                    {invoice.status === 'PAID' && <span className="text-green-600">âœ… æ”¯æ‰•æ¸ˆã¿</span>}
                    {invoice.status === 'OPEN' && <span className="text-yellow-600">â³ æœªæ‰•ã„</span>}
                    {invoice.status === 'VOID' && <span className="text-gray-600">âŒ ç„¡åŠ¹</span>}
                  </p>
                </div>
              </div>
            ))}
          </div>
        )}
      </Card>
    </div>
  );
}
```

---

## ğŸ“‹ å®æ–½æ­¥éª¤æ¸…å•

### âœ… Phase 1: Odoo 19 é…ç½®ï¼ˆé¢„è®¡ 2 å°æ—¶ï¼‰

- [ ] 1.1 è¿æ¥åˆ° Odoo 19 æœåŠ¡å™¨
- [ ] 1.2 å®‰è£…è®¢é˜…ç›¸å…³æ¨¡å—
- [ ] 1.3 åˆ›å»º 3 ä¸ªè®¢é˜…äº§å“
- [ ] 1.4 é…ç½®æ”¯ä»˜æ–¹å¼
- [ ] 1.5 è®°å½•äº§å“ ID

### âœ… Phase 2: ä»£ç å¼€å‘ï¼ˆé¢„è®¡ 4-6 å°æ—¶ï¼‰

- [ ] 2.1 æ›´æ–° `.env` æ·»åŠ  Odoo 19 é…ç½®
- [ ] 2.2 åˆ›å»º `src/lib/odoo19.ts`
- [ ] 2.3 æ›´æ–° Prisma Schema
- [ ] 2.4 æ‰§è¡Œæ•°æ®åº“è¿ç§»
- [ ] 2.5 åˆ›å»ºè®¢é˜…ç®¡ç† API
- [ ] 2.6 åˆ›å»ºå‰ç«¯è®¢é˜…é¡µé¢
- [ ] 2.7 è¿è¡Œç§å­è„šæœ¬
- [ ] 2.8 åŒæ­¥ Odoo 19 äº§å“ ID

### âœ… Phase 3: æµ‹è¯•ï¼ˆé¢„è®¡ 2 å°æ—¶ï¼‰

- [ ] 3.1 æœ¬åœ°æµ‹è¯•è®¢é˜…åˆ›å»º
- [ ] 3.2 æµ‹è¯• Odoo 19 è¿æ¥
- [ ] 3.3 æµ‹è¯•å‰ç«¯é¡µé¢æ˜¾ç¤º
- [ ] 3.4 æµ‹è¯•å‘ç¥¨ç”Ÿæˆ
- [ ] 3.5 æµ‹è¯•æ”¯ä»˜è®°å½•

### âœ… Phase 4: éƒ¨ç½²ï¼ˆé¢„è®¡ 1 å°æ—¶ï¼‰

- [ ] 4.1 æäº¤ä»£ç åˆ° Git
- [ ] 4.2 éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
- [ ] 4.3 è¿è¡Œç”Ÿäº§ç¯å¢ƒè¿ç§»
- [ ] 4.4 æ›´æ–°ç”Ÿäº§ç¯å¢ƒ `.env`
- [ ] 4.5 é‡å¯æœåŠ¡
- [ ] 4.6 éªŒè¯ç”Ÿäº§ç¯å¢ƒ

---

## ğŸ¯ æ€»ç»“

### æ¶æ„ä¼˜åŠ¿

1. **èŒè´£åˆ†ç¦»**
   - Odoo 19: ä¸“æ³¨è®¢é˜…ç®¡ç†å’Œè®¡è´¹
   - Odoo 18: ä¸“æ³¨ä¸šåŠ¡æ•°æ®
   - PostgreSQL: æœ¬åœ°ç¼“å­˜å’Œå¿«é€ŸæŸ¥è¯¢

2. **æ€§èƒ½ä¼˜åŒ–**
   - æœ¬åœ°ç¼“å­˜å‡å°‘ RPC è°ƒç”¨
   - 5 åˆ†é’ŸåŒæ­¥ç­–ç•¥å¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½
   - ç‹¬ç«‹æœåŠ¡å™¨é¿å…å•ç‚¹æ•…éšœ

3. **å¯æ‰©å±•æ€§**
   - æ˜“äºæ·»åŠ æ–°çš„è®¡è´¹å‘¨æœŸ
   - æ”¯æŒå¤šç§æ”¯ä»˜æ–¹å¼
   - å¯è½»æ¾å‡çº§/é™çº§è®¡åˆ’

### ä¸‹ä¸€æ­¥

1. å¼€å§‹ Phase 1 - Odoo 19 é…ç½®
2. éœ€è¦æˆ‘å¸®æ‚¨æ‰§è¡Œå“ªä¸ªæ­¥éª¤ï¼Ÿ

**éœ€è¦ç«‹å³å¼€å§‹å—ï¼Ÿ** ğŸš€
