name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      stack:
        description: 'Stack to rollback (odoo18-staging, odoo18-prod, erp-seisei, etc.)'
        required: true
        type: string
      steps_back:
        description: 'Number of successful deployments to rollback (default: 1)'
        required: false
        type: number
        default: 1

permissions:
  contents: read

env:
  SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST || '54.65.127.141' }}
  SSH_USER: ${{ secrets.DEPLOY_SSH_USER || 'ubuntu' }}
  REPO_PATH: /opt/seisei-odoo-addons

jobs:
  rollback:
    name: Rollback ${{ inputs.stack }} in ${{ inputs.environment }}
    runs-on: ubuntu-latest
    # Use GitHub Environments for protection rules
    environment: ${{ inputs.environment }}

    steps:
      - name: Validate inputs
        run: |
          STACK="${{ inputs.stack }}"
          ENV="${{ inputs.environment }}"
          STEPS_BACK="${{ inputs.steps_back }}"

          # Validate stack
          case "$STACK" in
            odoo18-staging|odoo18-prod|erp-seisei|erp-seisei-staging|ocr)
              ;;
            *)
              echo "::error::Unknown stack: $STACK"
              echo "::error::Supported: odoo18-staging, odoo18-prod, erp-seisei, erp-seisei-staging, ocr"
              exit 1
              ;;
          esac

          # Validate steps_back
          if [ "$STEPS_BACK" -lt 1 ]; then
            echo "::error::steps_back must be >= 1"
            exit 1
          fi

          echo "### Rollback Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Stack:** \`$STACK\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** \`$ENV\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Steps Back:** \`$STEPS_BACK\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor:** \`${{ github.actor }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID:** \`${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Add known_hosts
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Execute rollback
        id: rollback
        run: |
          STACK="${{ inputs.stack }}"
          ENV="${{ inputs.environment }}"
          STEPS_BACK="${{ inputs.steps_back }}"
          ACTOR="${{ github.actor }}"
          RUN_ID="${{ github.run_id }}"

          echo "::group::Rolling back $STACK ($ENV) by $STEPS_BACK steps"

          # Execute rollback via SSH (NO git pull - immutable release pattern)
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=accept-new \
            -o ConnectTimeout=10 \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} bash -s <<ENDSSH
          set -euo pipefail

          echo "=========================================="
          echo "Image as Source of Truth Rollback"
          echo "Stack:       $STACK"
          echo "Environment: $ENV"
          echo "Steps Back:  $STEPS_BACK"
          echo "Actor:       $ACTOR"
          echo "Run ID:      $RUN_ID"
          echo "=========================================="
          echo ""

          # Display current state
          echo "Current deployment manifest:"
          if [ -f /srv/releases/current/${STACK}.json ]; then
            cat /srv/releases/current/${STACK}.json | jq .
          else
            echo "No current manifest found"
          fi
          echo ""

          # Execute rollback script
          # Scripts are already executable (set during server preparation)
          # NO git pull - code in /opt is for scripts only
          # Runtime state is managed through /srv/releases/stacks
          sudo ${{ env.REPO_PATH }}/scripts/rollback.sh "$STACK" "$ENV" \
            --steps "$STEPS_BACK" \
            --actor "$ACTOR" \
            --run-id "$RUN_ID" 2>&1 | tee /tmp/rollback.log

          # Check exit status
          EXIT_CODE=\${PIPESTATUS[0]}
          if [ \$EXIT_CODE -eq 0 ]; then
            echo ""
            echo "✅ Rollback successful"

            # Display new current manifest
            if [ -f /srv/releases/current/${STACK}.json ]; then
              echo ""
              echo "New deployment manifest:"
              cat /srv/releases/current/${STACK}.json | jq .
            fi

            exit 0
          else
            echo ""
            echo "❌ Rollback failed (exit code: \$EXIT_CODE)"
            exit \$EXIT_CODE
          fi
          ENDSSH

          ROLLBACK_EXIT_CODE=$?
          echo "::endgroup::"

          # Set output based on result
          if [ $ROLLBACK_EXIT_CODE -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT

            # Get rolled back version from current manifest
            ROLLBACK_TAG=$(ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=accept-new \
              ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
              "cat /srv/releases/current/${{ inputs.stack }}.json 2>/dev/null | jq -r '.image_tag' || echo 'unknown'")

            echo "target=${ROLLBACK_TAG}" >> $GITHUB_OUTPUT
            echo "Rolled back to: ${ROLLBACK_TAG}"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "target=unknown" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Capture rollback results
        if: always()
        run: |
          STACK="${{ inputs.stack }}"
          ENV="${{ inputs.environment }}"

          echo "### Rollback Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** \`${{ steps.rollback.outputs.status || 'failed' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Rolled back to:** \`${{ steps.rollback.outputs.target || 'unknown' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get deployment details from server
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=accept-new \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} bash -s <<'ENDSSH' >> $GITHUB_STEP_SUMMARY

          echo "**Current deployment manifest:**"
          echo '```json'
          cat /srv/releases/current/${{ inputs.stack }}.json 2>/dev/null | jq . || echo "Manifest not found"
          echo '```'
          echo ""

          echo "**Recent deployment history:**"
          echo '```'
          grep "${{ inputs.stack }}" /srv/releases/deploy_history.log 2>/dev/null | tail -10 || echo "No history found"
          echo '```'
          echo ""

          echo "**Running containers:**"
          echo '```'
          cd /srv/stacks/${{ inputs.stack }} 2>/dev/null && sudo docker compose ps || echo "Stack not found"
          echo '```'
          echo ""

          echo "**Symlink verification:**"
          echo '```'
          readlink -f /srv/stacks/${{ inputs.stack }} || echo "Symlink not found"
          echo '```'
          ENDSSH

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
