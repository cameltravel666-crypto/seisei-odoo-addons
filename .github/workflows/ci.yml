name: CI

on:
  push:
    branches: [main, develop]
    tags:
      - 'main*'
      - 'v*'
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Lint shell scripts
        run: |
          find scripts -name "*.sh" -exec shellcheck {} \; || true

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            git fetch origin "${GITHUB_BASE_REF}"
            changed=$(git diff --name-only "origin/${GITHUB_BASE_REF}...HEAD" | grep -E '\.ya?ml$' || true)
            if [ -z "$changed" ]; then
              echo "No YAML changes detected; skipping yamllint."
              exit 0
            fi
            echo "$changed" | xargs yamllint --no-warnings
          else
            yamllint infra/ --no-warnings
          fi

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for secrets in code
        run: |
          echo "Checking for AWS access keys..."
          ! grep -rE "AKIA[A-Z0-9]{16}" --include="*.yml" --include="*.yaml" --include="*.env" . || exit 1

          echo "Checking for private keys..."
          ! grep -rE "-----BEGIN (RSA |EC |DSA )?PRIVATE KEY-----" --include="*.yml" --include="*.yaml" --include="*.env" . || exit 1

          echo "Checking for plaintext secrets..."
          ! grep -rE "(SECRET|PASSWORD|TOKEN)=['\"]?[a-zA-Z0-9_\-\.]{20,}" --include="*.yml" --include="*.yaml" --include="*.env" . | grep -v REDACTED | grep -v example || exit 1

          echo "No secrets found!"

      - name: Check for .env files (should be .example only)
        run: |
          env_files=$(find . -name ".env" -not -path "./.git/*" -not -name "*.example")
          if [ -n "$env_files" ]; then
            echo "Warning: Found .env files that might contain secrets:"
            echo "$env_files"
            echo "These should be .env.example files instead"
          fi

  yaml-validate:
    name: Validate YAML
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate compose files
        run: |
          pip install pyyaml
          for f in $(find infra/stacks -name "docker-compose*.yml" -o -name "docker-compose*.yaml"); do
            echo "Validating: $f"
            python -c "import yaml; yaml.safe_load(open('$f'))" || exit 1
          done
          echo "All compose files are valid YAML"

      - name: Validate traefik configs
        run: |
          for f in $(find infra/stacks/edge-traefik -name "*.yml" -o -name "*.yaml"); do
            echo "Validating: $f"
            python -c "import yaml; yaml.safe_load(open('$f'))" || exit 1
          done
          echo "All traefik configs are valid YAML"

      - name: Validate workflow YAML
        run: |
          for f in $(find .github/workflows -name "*.yml" -o -name "*.yaml"); do
            echo "Validating: $f"
            python -c "import yaml; yaml.safe_load(open('$f'))" || exit 1
          done
          echo "All workflow files are valid YAML"

  python-validate:
    name: Python Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Compile Python files
        run: |
          TARGETS=()
          if [ -d odoo_modules ]; then
            TARGETS+=("odoo_modules")
          fi
          if [ -d addons ]; then
            TARGETS+=("addons")
          fi

          if [ ${#TARGETS[@]} -eq 0 ]; then
            echo "No Python addon directories found; skipping compileall."
            exit 0
          fi

          python -m compileall "${TARGETS[@]}"

      - name: Unit tests (placeholder if none configured)
        run: |
          if [ -f pytest.ini ] || [ -f tox.ini ] || [ -f pyproject.toml ]; then
            python -m pip install pytest
            python -m pytest -q || exit 1
          else
            echo "No pytest/tox configuration found; unit tests not configured."
          fi

  route-check:
    name: Route Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Validate routes
        run: |
          ./scripts/validate_routes.sh --local || echo "Route check completed with warnings"

  build-artifact:
    name: Build Artifact
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: [lint, security-check, yaml-validate]
    steps:
      - uses: actions/checkout@v4

      - name: Extract tag name
        id: tag
        run: echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Create release tarball
        run: |
          ./scripts/make_release_tarball.sh --tag ${{ steps.tag.outputs.TAG }} --skip-sanitize

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: seisei-${{ steps.tag.outputs.TAG }}
          path: dist/releases/${{ steps.tag.outputs.TAG }}/
          retention-days: 30
