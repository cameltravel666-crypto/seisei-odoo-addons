name: Deploy Traefik QR-BFF Routes

on:
  push:
    branches: [main]
    paths:
      - 'apps/qr-bff/traefik/**'
      - '.github/workflows/deploy-traefik-qr-bff.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Traefik Routes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy Traefik config to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          source: "apps/qr-bff/traefik/qr-bff-routes.yml"
          target: "/tmp/traefik-deploy"
          strip_components: 3

      - name: Deploy QR-BFF Traefik routes
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script: |
            set -e
            sudo cp /tmp/traefik-deploy/qr-bff-routes.yml /srv/stacks/edge-traefik/dynamic/qr-bff.yml
            echo "Traefik routes updated. Waiting for auto-reload..."
            sleep 3
            sudo docker logs edge-traefik --tail 10 2>&1 | grep -i "configuration" || true
            echo "QR-BFF Traefik routes deployed successfully"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script: |
            sleep 5
            curl -sf http://localhost:3100/v1/qr/health 2>/dev/null && echo "Internal health check passed" || echo "Internal check failed"
            curl -sf https://qr.seisei.tokyo/v1/qr/health 2>/dev/null && echo "External health check passed" || echo "External endpoint pending"

      - name: Deployment summary
        run: |
          echo "## Traefik QR-BFF Routes Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Domain**: qr.seisei.tokyo" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: qr-bff:3100" >> $GITHUB_STEP_SUMMARY
          echo "- **Operator**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
