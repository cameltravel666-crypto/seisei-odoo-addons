name: Update Server Scripts

on:
  workflow_dispatch:
    inputs:
      server:
        description: 'Target server (staging/production)'
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging

permissions:
  contents: read

env:
  REPO_PATH: /opt/seisei-odoo-addons

jobs:
  update-scripts:
    name: Update scripts on ${{ inputs.server }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.server }}
    env:
      SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST || '54.65.127.141' }}
      SSH_USER: ${{ secrets.DEPLOY_SSH_USER || 'ubuntu' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Sync repo to server
        run: |
          echo "::group::Syncing to ${{ inputs.server }} server"

          SSH_CMD="ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new -o ConnectTimeout=10"
          REMOTE="${{ env.SSH_USER }}@${{ env.SSH_HOST }}"

          chmod +x scripts/*.sh

          # Sync repo directly (deploy user has group write via ubuntu group)
          # --ignore-errors: continue past permission-denied files (e.g. root-owned odoo_ocr_final)
          # Exit code 23 (partial transfer) is acceptable — verify step confirms critical files landed
          rsync -rlz --no-perms --no-owner --no-group --no-times --ignore-errors \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='node_modules/' \
            --exclude='.next/' \
            --exclude='src/' \
            --exclude='prisma/' \
            --exclude='package.json' \
            --exclude='package-lock.json' \
            --exclude='tsconfig.json' \
            --exclude='next.config.*' \
            -e "$SSH_CMD" \
            ./ $REMOTE:${{ env.REPO_PATH }}/ || {
              RC=$?
              if [ $RC -eq 23 ]; then
                echo "::warning::rsync partial transfer (exit 23) — some files skipped due to permissions"
              else
                echo "::error::rsync failed with exit code $RC"
                exit $RC
              fi
            }

          echo "::endgroup::"

      - name: Verify update
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=accept-new \
            -o ConnectTimeout=10 \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
            "echo 'Scripts:' && ls -la ${{ env.REPO_PATH }}/scripts/*.sh && echo '' && echo 'Odoo modules:' && ls ${{ env.REPO_PATH }}/odoo_modules/seisei/"

          echo "### Server Repository Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** \`${{ inputs.server }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Path:** \`${{ env.REPO_PATH }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Repository synced to latest main" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next step:** Restart Odoo container to load updated modules." >> $GITHUB_STEP_SUMMARY

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
