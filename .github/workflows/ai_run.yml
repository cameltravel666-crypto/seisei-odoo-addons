name: AI Run (Self-Hosted)

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to run"
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  ai-run:
    name: ai-run
    if: github.event_name == 'workflow_dispatch' || github.event.label.name == 'ai-run'
    runs-on: [self-hosted, ai-executor]
    steps:
      - name: Resolve issue metadata
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNumber = context.eventName === "workflow_dispatch"
              ? Number(context.payload.inputs.issue_number)
              : context.payload.issue.number;

            const { data: issue } = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber
            });

            core.setOutput("number", issueNumber);
            core.setOutput("title", issue.title || "");
            core.setOutput("url", issue.html_url || "");

      - name: Ensure auto branch exists
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNumber = Number("${{ steps.issue.outputs.number }}");
            const ref = `heads/auto/issue-${issueNumber}`;

            try {
              await github.rest.git.getRef({ owner, repo, ref });
            } catch (error) {
              if (error.status === 404) {
                core.setFailed(
                  "Auto branch not found. Add label 'ready-for-dev' first to create the draft PR branch."
                );
                return;
              }
              throw error;
            }

      - name: Checkout auto branch
        uses: actions/checkout@v4
        with:
          ref: auto/issue-${{ steps.issue.outputs.number }}
          fetch-depth: 0

      - name: Run AI command
        id: ai_run
        env:
          AI_RUN_CMD: ${{ vars.AI_RUN_CMD }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.title }}
          ISSUE_URL: ${{ steps.issue.outputs.url }}
        run: |
          if [ -z "$AI_RUN_CMD" ]; then
            echo "::error::AI_RUN_CMD is not set. Define it in Repo Settings → Actions → Variables."
            exit 1
          fi
          echo "Running AI command: $AI_RUN_CMD"
          bash -lc "$AI_RUN_CMD"

      - name: Commit and push changes
        if: success()
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "ai-executor"
            git config user.email "ai-executor@users.noreply.github.com"
            git add -A
            git commit -m "ai: update for issue #$ISSUE_NUMBER"
            git push origin HEAD
          else
            echo "No changes detected. Skipping commit."
          fi

      - name: Comment on issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNumber = Number("${{ steps.issue.outputs.number }}");
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            const body = [
              "AI run completed.",
              "",
              `- Result: **${{ job.status }}**`,
              `- Branch: \`auto/issue-${issueNumber}\``,
              `- Run: ${runUrl}`,
              "",
              "If changes were produced, review the draft PR and request approval."
            ].join("\n");

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body
            });
