name: Deploy QR-BFF Service

on:
  push:
    branches: [main]
    paths:
      - 'apps/qr-bff/**'
      - '.github/workflows/deploy-qr-bff.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/qr-bff

jobs:
  build-and-deploy:
    name: Build and Deploy QR-BFF
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/qr-bff
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          envs: REGISTRY,IMAGE_NAME
          script: |
            set -e

            # Pull latest image
            docker pull $REGISTRY/$IMAGE_NAME:latest

            # Stop existing container if running
            docker stop qr-bff 2>/dev/null || true
            docker rm qr-bff 2>/dev/null || true

            # Load env vars from odoo18-prod
            source /srv/stacks/odoo18-prod/.env 2>/dev/null || true

            # Start qr-bff container
            docker run -d \
              --name qr-bff \
              --restart unless-stopped \
              --network seisei-odoo-network \
              -e PORT=3100 \
              -e REDIS_HOST=odoo-redis \
              -e REDIS_PORT=6379 \
              -e REDIS_PASSWORD="${REDIS_PASSWORD:-changeme}" \
              -e REDIS_DB=1 \
              -e ODOO_URL=http://seisei-odoo-router:80 \
              -e ODOO_SERVICE_LOGIN="${QR_SERVICE_LOGIN:-test}" \
              -e ODOO_SERVICE_PASSWORD="${QR_SERVICE_PASSWORD:-test123}" \
              -e ODOO_TIMEOUT=30000 \
              -e ODOO_RETRIES=2 \
              -e DEFAULT_DB=ten_testodoo \
              --memory=256m \
              --cpus=0.5 \
              $REGISTRY/$IMAGE_NAME:latest

            # Connect to additional networks
            docker network connect odoo18-prod_odoo-internal qr-bff || true
            docker network connect edge qr-bff || true

            # Wait for container to be healthy
            sleep 5
            docker logs qr-bff --tail 20

            echo "QR-BFF deployed successfully"

      - name: Create demo token in Redis
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script: |
            # Load env vars
            source /srv/stacks/odoo18-prod/.env 2>/dev/null || true
            REDIS_PASS="${REDIS_PASSWORD:-changeme}"

            # Create demo token if not exists
            docker exec odoo-redis redis-cli -a "$REDIS_PASS" -n 1 \
              SETNX "qr:token:R8YxZM3IsfFwYz6qp1C5_g" \
              '{"tenantDb":"ten_testodoo","status":"active","tableName":"Demo Table"}' || true

            # Set expiration (1 year)
            docker exec odoo-redis redis-cli -a "$REDIS_PASS" -n 1 \
              EXPIRE "qr:token:R8YxZM3IsfFwYz6qp1C5_g" 31536000 || true

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script: |
            # Test health endpoint
            curl -sf http://localhost:3100/v1/qr/health && echo "Health check passed" || echo "Health check failed"

            # Test via Traefik (if configured)
            curl -sf https://qr.seisei.tokyo/v1/qr/health 2>/dev/null && echo "External health check passed" || echo "External endpoint not yet configured"

      - name: Deployment summary
        run: |
          echo "## QR-BFF Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "- **Container**: qr-bff" >> $GITHUB_STEP_SUMMARY
          echo "- **Port**: 3100" >> $GITHUB_STEP_SUMMARY
          echo "- **Operator**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
