name: Deploy

on:
  workflow_dispatch:
    inputs:
      stack:
        description: 'Stack to deploy'
        required: true
        type: choice
        options:
          - erp-seisei
          - web-seisei
          - odoo18-test
          - odoo18-prod
          - ocr
          - langbot
          - edge-traefik
      version:
        description: 'Version/tag to deploy (default: latest)'
        required: false
        default: 'latest'
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - stage
          - prod
        default: 'stage'

  workflow_run:
    workflows: ["Build and Push Images"]
    types: [completed]
    branches: [main]

jobs:
  deploy-stage:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    environment:
      name: ${{ github.event.inputs.environment || 'stage' }}

    steps:
      - uses: actions/checkout@v4

      - name: Determine deployment params
        id: params
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "stack=${{ github.event.inputs.stack }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "env=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            # Auto-deploy ERP on main push
            echo "stack=erp-seisei" >> $GITHUB_OUTPUT
            echo "version=$(date +%Y%m%d)-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
            echo "env=stage" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /srv/scripts
            ./deploy.sh ${{ steps.params.outputs.stack }} ${{ steps.params.outputs.version }} ${{ steps.params.outputs.env }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "Deployment failed!"
          echo "Stack: ${{ steps.params.outputs.stack }}"
          echo "Version: ${{ steps.params.outputs.version }}"

  smoke-test:
    runs-on: ubuntu-latest
    needs: deploy-stage
    if: github.event.inputs.environment == 'stage' || github.event_name == 'workflow_run'

    steps:
      - name: Run smoke tests
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            /srv/scripts/smoke-test.sh ${{ github.event.inputs.stack || 'erp-seisei' }}

  promote-to-prod:
    runs-on: ubuntu-latest
    needs: smoke-test
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.environment == 'prod'
    environment:
      name: production

    steps:
      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /srv/scripts
            ./deploy.sh ${{ github.event.inputs.stack }} ${{ github.event.inputs.version }} prod

      - name: Final smoke test
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            /srv/scripts/smoke-test.sh ${{ github.event.inputs.stack }}
