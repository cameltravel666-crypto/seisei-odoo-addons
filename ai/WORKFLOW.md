# WORKFLOW.md - 四方协作工作流

> 用途: 定义用户 → ChatGPT → Claude Code → Cursor 的完整工作流
> 编码: UTF-8

---

## 工作流概览

```
用户 (Owner/PM)
    │
    │ 提出问题 + 目标 + 风险偏好
    │ 只做 Gate2 批准，不手动敲服务器命令
    ▼
ChatGPT (Architect/PMO)
    │
    │ 拆解任务 → 选择工作流 → 输出 prompt
    │ 定义验收标准、证据清单、回滚策略
    ▼
Claude Code (Repo Detective/审计官)
    │
    │ 读仓库、定位根因、提出变更方案
    │ 给出验证/证据命令清单
    │ 不直接动生产（除非在 Cursor 驾驶舱且被标记为 AUTO）
    ▼
Cursor (Driver/执行官)
    │
    │ 统一驾驶仓（terminal + git + 文件编辑）
    │ 按 WO 自动执行、收集证据、更新快照与报告
    ▼
验收 → 快照更新 → 关闭 WO
```

---

## 详细流程

### Phase 1: 需求输入

**输入**:
- 问题描述
- 目标定义
- 风险偏好
- 约束条件

**输出**: 需求文档（可选）

---

### Phase 2: 任务拆解 (ChatGPT)

**职责**:
1. 分析需求，拆解为可执行任务
2. 选择合适的工作流（修复/新功能/优化/迁移）
3. 生成给 Claude Code / Cursor 的 prompt
4. 定义验收标准（AC）
5. 定义证据清单
6. 定义回滚策略

**输出**:
- 工作单 (Work Order)
- Gate2 提案（如需要）
- 验收标准清单

---

### Phase 3: 审计与方案 (Claude Code)

**职责**:
1. 读仓库，理解代码结构
2. 定位根因（通过日志、代码、配置）
3. 提出变更方案（最小补丁原则）
4. 给出验证命令清单
5. 给出证据收集命令清单
6. 评估风险，标记 Gate2 项

**输出**:
- 根因分析报告
- 变更方案（最小补丁）
- 验证命令清单
- 证据收集命令清单
- 风险评估（Gate2 标记）

**约束**:
- 不直接修改生产代码（除非在 Cursor 驾驶舱且被标记为 AUTO）
- 必须提供"命中实例证据"（DNS → 反代 → 容器/进程 → DB → addons_path → 模块版本）

---

### Phase 4: 执行 (Cursor)

**职责**:
1. 接收 WO 和变更方案
2. 自动执行（AUTO 区域）
3. 收集证据（evidence/run/acceptance 三份日志）
4. 更新快照（SYNC_SNAPSHOT.latest.md）
5. 更新报告（REPORT.md 或 PROJECT_STATUS.md）

**执行模式**:
- **AUTO**: 连续执行到验收结束，无需确认
- **Gate2**: 遇到 Gate2 项时，输出 Gate2 表格并暂停，等待批准

**输出**:
- 执行日志（run.log）
- 证据日志（evidence.log）
- 验收日志（acceptance.log）
- 更新的快照文件
- Gate2 提案（如需要）

---

### Phase 5: 验收与关闭

**职责**:
1. 验证验收标准（AC）
2. 检查证据完整性
3. 更新 SYNC_SNAPSHOT
4. 关闭 WO

**输出**:
- 验收报告
- 更新的快照
- 关闭的 WO

---

## 工作流类型

### 1. 修复工作流 (Bug Fix)

```
问题报告 → 根因分析 → 最小补丁 → 执行 → 验证 → 关闭
```

### 2. 新功能工作流 (Feature)

```
需求 → 设计 → 实现 → 测试 → 部署 → 验收 → 关闭
```

### 3. 优化工作流 (Optimization)

```
性能问题 → 分析 → 优化方案 → 执行 → 验证 → 关闭
```

### 4. 迁移工作流 (Migration)

```
迁移需求 → 方案设计 → 备份 → 执行 → 验证 → 关闭
```

---

## 关键节点

### Gate2 检查点

**何时触发 Gate2**:
- 生产数据库修改（修复/迁移）
- 生产服务重启
- 删除生产数据
- 修改网络拓扑
- 安全相关变更

**Gate2 流程**:
1. Cursor 检测到 Gate2 项
2. 输出 Gate2 表格（风险/影响/回滚/验证）
3. 暂停执行
4. 等待用户批准
5. 批准后继续执行

### 证据收集点

**必须收集的证据**:
- 版本标记（代码版本、模块版本）
- 命中实例链路（DNS → 反代 → 容器 → DB → 路径）
- 请求/响应关键字段（脱敏后）
- 日志片段（结构化报错）
- 数据库状态（to_regclass、表结构）

---

## 工具使用

### snapshot_collect.sh
- 收集系统状态（git、docker、systemd、数据库）
- 自动脱敏（token/key/secret）
- 输出原始数据

### snapshot_render.py
- 读取原始数据
- 渲染为结构化快照（Markdown）
- 写入 SYNC_SNAPSHOT.latest.md

---

*End of WORKFLOW*

