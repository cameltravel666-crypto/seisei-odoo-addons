# Odoo Database Router
# Fixed: Remove 302 redirects that convert POST to GET

# 租户数据库映射
map $host $tenant_db {
    admin.erp.seisei.tokyo                            "";
    testodoo.seisei.tokyo                             ten_testodoo;
    demo.nagashiro.top                                ten_testodoo;
    ~^(?<subdomain>[a-z0-9]+)\.erp\.seisei\.tokyo$    ten_$subdomain;
    default                                           "";
}

# 判断是否是租户子域名（需要限制直接访问）
map $host $is_tenant_subdomain {
    admin.erp.seisei.tokyo      0;
    testodoo.seisei.tokyo       0;
    demo.nagashiro.top          0;
    ~^[a-z0-9]+\.erp\.seisei\.tokyo$  1;
    default                     0;
}

map $http_x_forwarded_proto $real_scheme {
    https   https;
    default $scheme;
}

server {
    client_max_body_size 50M;
    listen 80;
    server_name _;

    # ============================================
    # 健康检查
    # ============================================
    location = /nginx-health {
        return 200 OK;
        add_header Content-Type text/plain;
    }

    # ============================================
    # 租户子域名：重定向 Web 界面到 BizNexus
    # ============================================
    
    # /web/login → 重定向到 BizNexus
    location = /web/login {
        if ($is_tenant_subdomain = 1) {
            return 302 https://biznexus.seisei.tokyo/login;
        }
        
        # 管理员入口：正常代理
        proxy_pass http://seisei-project-web:8069;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $tenant_db;
        proxy_cookie_flags ~ secure;
    }

    # / 根路径 → 租户重定向到 BizNexus
    location = / {
        if ($is_tenant_subdomain = 1) {
            return 302 https://biznexus.seisei.tokyo;
        }
        
        # 直接代理，不再 302 重定向
        proxy_pass http://seisei-project-web:8069;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $tenant_db;
        proxy_cookie_flags ~ secure;
    }

    # /odoo 路径 → 租户重定向到 BizNexus
    location = /odoo {
        if ($is_tenant_subdomain = 1) {
            return 302 https://biznexus.seisei.tokyo;
        }
        
        proxy_pass http://seisei-project-web:8069;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $tenant_db;
        proxy_cookie_flags ~ secure;
    }

    # ============================================
    # API 路由 - 允许（BizNexus 需要）
    # ============================================
    
    # JSON-RPC / XML-RPC API
    location ~ ^/(jsonrpc|xmlrpc) {
        proxy_pass http://seisei-project-web:8069;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $tenant_db;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        proxy_cookie_flags ~ secure;
    }

    # Web API endpoints (session, dataset, action)
    location ~ ^/web/(session|dataset|action) {
        proxy_pass http://seisei-project-web:8069;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $tenant_db;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        proxy_cookie_flags ~ secure;
    }

    # Web webclient endpoints  
    location ~ ^/web/webclient {
        proxy_pass http://seisei-project-web:8069;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $tenant_db;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        proxy_cookie_flags ~ secure;
    }

    # Mail endpoints
    location ~ ^/mail/ {
        proxy_pass http://seisei-project-web:8069;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $tenant_db;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        proxy_cookie_flags ~ secure;
    }

    # ============================================
    # 静态资源 - 允许
    # ============================================
    
    location ~ ^/web/(static|assets)/ {
        proxy_pass http://seisei-project-web:8069;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $tenant_db;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        proxy_cookie_flags ~ secure;
    }

    # Binary/Image resources
    location ~ ^/web/(binary|image)/ {
        proxy_pass http://seisei-project-web:8069;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $tenant_db;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        proxy_cookie_flags ~ secure;
    }

    # WebSocket endpoints - must use gevent port 8072
    location ~ ^/(websocket|bus/) {
        proxy_pass http://seisei-project-web:8072;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $tenant_db;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        proxy_cookie_flags ~ secure;
    }

    # ============================================
    # QR Ordering API - 直接代理，不重定向
    # ============================================
    location ~ ^/qr/ {
        proxy_pass http://seisei-project-web:8069;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $tenant_db;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        proxy_cookie_flags ~ secure;
    }

    # 默认路由
    # ============================================
    location / {
        # 租户子域名访问时重定向到 BizNexus
        if ($is_tenant_subdomain = 1) {
            return 302 https://biznexus.seisei.tokyo;
        }
        
        # 直接代理到 Odoo，使用 X-Odoo-dbfilter 头设置数据库
        proxy_pass http://seisei-project-web:8069;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $tenant_db;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        
        proxy_cookie_flags ~ secure;
    }
}
