你是 Claude Code（顶级 DevOps/Platform Engineer）。目标：在现有仓库 seisei-odoo-addons 的“工业级部署系统”（scripts/*.sh + docs/*.md）基础上，完成“最终部署闭环”= GitHub CI/CD（构建→发布→部署→回滚）+ 服务器安全与审计 + 配置漂移消除。要求：不重写现有 7 个脚本逻辑，只做补齐与集成；以 scripts/deploy.sh 和 scripts/rollback.sh 为唯一入口；严格遵守 preflight（禁 latest/禁 build/只 pull/Promotion）。

## 0. 关键信息（已确定）
Repo Root（服务器）: /opt/seisei-odoo-addons
本地工作目录（开发）: /Users/taozhang/Projects/seisei-odoo-addons

Stack Map（来自 scripts/lib.sh STACK_MAP）：
- odoo18-prod    -> /srv/stacks/odoo18-prod      domain https://demo.nagashiro.top
- odoo18-staging -> /srv/stacks/odoo18-staging   domain https://staging.erp.seisei.tokyo
- web-seisei     -> /srv/stacks/web-seisei       domain https://biznexus.seisei.tokyo
- ocr            -> /srv/stacks/ocr              health http://localhost:8180/health
- langbot        -> /srv/stacks/langbot
- edge-traefik   -> /srv/stacks/edge-traefik

部署命令格式（必须保持一致）：
- /opt/seisei-odoo-addons/scripts/deploy.sh odoo18-staging staging sha-<commit>
- /opt/seisei-odoo-addons/scripts/deploy.sh odoo18-prod prod sha-<commit>   # 必须 staging verified
- /opt/seisei-odoo-addons/scripts/deploy.sh web-seisei prod sha-<commit>
- /opt/seisei-odoo-addons/scripts/deploy.sh ocr prod sha-<commit>

版本变量名（来自 scripts/lib.sh get_version_var）：
- odoo18-prod, odoo18-staging -> ODOO18_IMAGE_TAG
- ocr -> OCR_IMAGE_TAG
- web-seisei -> WWW_IMAGE_TAG
- langbot -> VERSION
- edge-traefik -> VERSION

## 1. 目标交付（必须全部完成）
A) GitHub Actions：构建并推送 GHCR 镜像（sha tag），并可触发服务器部署
B) GitHub Actions：支持“一键回滚”（应用层回滚，默认不回滚 DB）
C) 服务器侧：最小权限 SSH 用户/密钥/ sudo 规则（只允许运行 deploy/rollback/sync 与 docker compose 操作），并有审计日志
D) 配置漂移治理：nginx router 配置不得手改；要纳入某个 stack 的“受控发布”路径（通过 deploy.sh / sync_to_srv.sh 同步或单独 stack 管理），避免再次白屏/登录问题
E) 文档更新：补一份 docs/GITHUB_CICD.md（或同等）给出从 0 到 1 的操作步骤与回滚演练

## 2. 约束与原则
- 现有 scripts/* 是权威：deploy.sh/rollback.sh/preflight.sh/smoke.sh/backup.sh/sync_to_srv.sh/lib.sh 逻辑尽量不改；如需改，只允许“向后兼容的补充”，不得破坏既有命令行接口。
- prod 只能 pull GHCR 的 sha-xxxx 镜像；不得在服务器 build。
- prod 部署必须验证 staging（Promotion 机制）；Actions 也必须遵守。
- 回滚默认只回滚镜像版本（应用层），不自动恢复 DB；DB restore 作为手工流程（明确提示风险）。
- 所有 workflow 需可手动触发（workflow_dispatch），并支持输入 stack/env/sha；对 odoo18-prod 强制校验 staging verified。
- 不能把任何 secret 明文写入仓库；使用 GitHub Secrets。
- 兼容多个 stack，不要只写死 odoo18。

## 3. 需要你实现的具体内容（按步骤完成）
### 3.1 新增 GitHub Actions workflows（在 .github/workflows）
1) build_ghcr.yml
- 在 push 到 main（以及 workflow_dispatch）时运行
- 产物：至少构建并推送以下镜像 tag 格式（按现有 repo 约定，不确定的以现有 docs/WWW_GHCR_WORKFLOW.md 为准）：
  - ghcr.io/<owner>/seisei-odoo18:sha-<shortsha>   （Odoo18 镜像）
  - ghcr.io/<owner>/seisei-ocr:sha-<shortsha>      （OCR 镜像，如存在）
  - ghcr.io/<owner>/seisei-www:sha-<shortsha>      （web-seisei 镜像，如存在）
- 如果仓库里已有 Dockerfile/构建路径，请自动探测；没有就按当前 repo 结构写死路径，但要在 workflow 里清晰注明并可配置。
- 使用 docker/build-push-action，开启 build cache（ghcr cache）。
- 需要在镜像 labels 写入 org.opencontainers.image.revision=fullsha、source=repo url。

2) deploy.yml
- workflow_dispatch 输入：
  - stack（choice: odoo18-staging, odoo18-prod, web-seisei, ocr, langbot, edge-traefik）
  - env（choice: staging, prod, infra；但要自动约束：odoo18-staging=staging, odoo18-prod=prod, web-seisei=prod, ocr=prod, edge-traefik=infra, langbot=prod）
  - sha（string，例如 sha-19b9b98；允许只输入短 commit，让 workflow 自动转成 sha-xxxx 格式）
  - promote_to_prod（bool，仅当 stack=odoo18-staging 才可选；若 true 则 staging 成功并 verified 后自动触发 prod deploy）
- 行为：
  - 通过 SSH 连接服务器（47.245.12.205 或者从 secrets 提供 HOST）
  - 在服务器上：
    - cd /opt/seisei-odoo-addons && git fetch && git checkout main && git pull（或固定到某个 ref，需说明）
    - chmod +x scripts/*.sh
    - 确保目录存在：/srv/stacks /srv/backups /srv/releases/verified /srv/deploy-history.log
    - 运行：./scripts/deploy.sh <stack> <env> <shaTag>
  - 对 odoo18-prod：必须要求 /srv/releases/verified/odoo18-staging.txt == <shaTag>，否则失败。
  - 把 deploy 输出保存为 Actions artifact（日志）并在 summary 里展示关键结果（最终镜像 tag、smoke pass/fail、domain check）。

3) rollback.yml
- workflow_dispatch 输入：
  - stack（同上）
  - env（自动约束）
  - steps_back（int，默认 1）
  - target_sha（可选，若提供则回滚到指定 sha，否则按 steps_back 从 /srv/deploy-history.log 选择）
- 在服务器执行：./scripts/rollback.sh <stack> <env> --steps <n> 或 --to <sha>（若 rollback.sh 目前没有这些参数，你需要以“兼容方式”补齐 rollback.sh 参数解析，但保留旧用法）
- 同样保存回滚日志为 artifact，并在 summary 给出 “回滚到的 sha / smoke 结果 / domain check”。

### 3.2 服务器侧最小权限部署用户（安全）
新增 docs 和可执行脚本（例如 scripts/server_bootstrap_deployer.sh，必须幂等）完成：
- 创建用户：deployer（无 shell 或受限 shell 可选，但要实用）
- 配置 ~/.ssh/authorized_keys（由 GitHub Secret 注入，不写死）
- /etc/sudoers.d/seisei-deployer：只允许执行以下命令（NOPASSWD）：
  - /opt/seisei-odoo-addons/scripts/deploy.sh
  - /opt/seisei-odoo-addons/scripts/rollback.sh
  - /opt/seisei-odoo-addons/scripts/sync_to_srv.sh
  - /usr/bin/docker, /usr/local/bin/docker（按实际路径探测）
  - /usr/bin/docker-compose 或 docker compose（按实际）
  - 以及必要的 systemctl reload nginx（如果你把 nginx 也纳入 stack 管理）
- 明确记录审计：把每次 deploy/rollback 的调用（用户/时间/参数/sha）追加到 /srv/deploy-history.log（如果脚本已做就不重复；否则补齐）

### 3.3 Nginx router 配置漂移治理（必须解决）
背景：之前手改 /opt/seisei-odoo/nginx/default.conf 导致 demo 登录白屏/重定向错误，回滚后恢复。要求：
- 任何 nginx 配置变更必须纳入受控发布（通过 repo + deploy.sh/sync_to_srv.sh 或单独 stack）。
- 你需要选择一种方案并落地（优先 A）：

方案 A（优先）：把 router 配置作为 edge-traefik 或新增 stack（例如 edge-nginx-router）纳入 /srv/stacks，并由 deploy.sh 同步配置到 /opt/seisei-odoo/nginx，然后 docker exec reload nginx。要求：
- 配置文件版本化（仓库内路径固定，例如 infra/router-nginx/default.conf）
- sync_to_srv.sh 把其同步到 /srv/stacks/<stack>/...
- deploy.sh 对该 stack 做：preflight->backup config->sync->nginx -t -> reload -> smoke（/nginx-health + 关键域名 HEAD）
- 不允许直接在 /opt/seisei-odoo/nginx 改；添加一个保护：docs 指定流程；可选：给 /opt/seisei-odoo/nginx 挂载只读或写入需要 root（提示即可）

方案 B：继续手工但增加监控/漂移检测（不推荐，除非 A 太大）。若选 B，必须提供 drift_check.sh 对比 repo 与 /opt/... 并在 deploy 前阻止。

无论选 A/B，都要在 docs 里写清楚“如何修改 router 并发布”，并给出回滚方式。

### 3.4 文档与验收
新增/更新以下文档：
- docs/GITHUB_CICD.md
  - Secrets 列表（HOST, SSH_KEY, SSH_USER, GHCR_TOKEN 等）
  - 如何触发 build、deploy、promote、rollback
  - 演练：staging 部署 sha-xxxx -> 验证 -> promote prod -> rollback prod
  - 常见故障排查（ssh、verified 不匹配、smoke fail）
- 更新 docs/DEPLOYMENT.md：加一节 “CI/CD 模式（GitHub Actions）” 和 “Nginx router 变更流程”。

## 4. 实现细节要求（必须遵守）
- Workflow 中所有敏感信息只从 GitHub Secrets 获取
- SSH 需启用 StrictHostKeyChecking（可用 known_hosts 或 ssh-keyscan + pinned fingerprint；给出最小可行）
- 对 stack/env 的约束必须在 workflow 层面强制（防止误操作）
- 每个 workflow 的 Actions Summary 必须输出：
  - stack/env
  - requested sha、normalized shaTag（sha-xxxx）
  - 服务器返回的最终运行镜像（docker inspect）
  - smoke 结果（PASS/FAIL）
  - 对应域名/health check 结果

## 5. 你需要在 repo 中实际修改/新增哪些文件（输出清单）
- .github/workflows/build_ghcr.yml
- .github/workflows/deploy.yml
- .github/workflows/rollback.yml
- （可选）scripts/server_bootstrap_deployer.sh
- （如需）scripts/rollback.sh 参数兼容增强
- （如需）新增 stack/目录（例如 infra/router-nginx/* 或 /stacks/edge-nginx-router/*）
- docs/GITHUB_CICD.md
- docs/DEPLOYMENT.md（追加 CI/CD & router 流程）

## 6. 验收（你必须提供命令/步骤）
提供一个“从 0 到 1 完整跑通”的验收步骤列表，包括：
- 在 GitHub 上手动触发 build（输出生成的 sha tag）
- 触发 deploy odoo18-staging
- 确认 /srv/releases/verified/odoo18-staging.txt 被写入
- 触发 promote（或 deploy odoo18-prod），确认门禁生效
- 故意回滚 steps_back=1，确认恢复
- router 配置变更示例：修改 server_name demo.nagashiro.top 的处理逻辑 -> 通过 stack 发布 -> nginx -t + reload -> 访问 demo 正常

现在开始执行：在本仓库内完成上述所有改动，给出最终变更文件内容（diff 或完整文件），并确保与现有 scripts/deploy.sh 接口一致。
