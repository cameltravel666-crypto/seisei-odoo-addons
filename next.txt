你是 Claude Code（资深全栈架构/实施工程师）。请基于以下现状与目标，为 Seisei BizNexus 实施“OCR 识别 → 会计软件导入模板导出”的完整工程改造，并直接输出可执行的任务拆解、代码改动点、API 契约、数据结构、UI 方案与验收标准。

# 0. 项目背景（现状）
- 已有：单张发票/收据识别体验（Try OCR 落地页）与识别结果展示。
- 订阅/权限：通过 Stripe 订阅，权限已配置完毕（不需要你重建 Stripe 产品）。
- 定价体系：展示在 https://seisei.tokyo/pricing（基础计划 + 追加模块结构）。当前“追加模块”在财务/会计类已包含「現金出納帳」「会計Pro」「会計エンタープライズ」等。请把本次“导出能力”作为可控的模块/权限能力融入现有结构（不要求你改定价页内容，但要保证产品内的模块/权限可以挂载到该体系）。参考：定价页模块结构与展示。 
- 计费中间件：前端/服务端需要调用 Odoo 19 的“中央服务”进行：
  1) entitlement（订阅权限）校验
  2) usage（识别用量）扣减与超额计费：每月 30 张免费，超出 20 日元/张（已存在）
- 存储：识别文件/导出文件需要可追踪、可下载（建议 S3 + 签名 URL）。
- 目标导出：优先支持日本主流财务软件的“仕訳导入/仕訳帳导入”模板导出，可由用户选择：
  - freee
  - マネーフォワード（MFクラウド会計）
  - 弥生会計
  （Phase2：奉行/PCA/TKC 等先留扩展接口即可）

# 1. 目标（必须达成）
A) 落地页（Try OCR）漏斗升级（强获客、强转化）
- 未登录也允许上传并完成 1 张识别（保持低摩擦）。
- 识别完成后新增“导出预览（Preview）”区：用户可选择目标软件（freee/MF/弥生），并看到与模板列名一致的 3~10 行预览表格（或 1~2 行也可，但列名必须准确）。
- “下载导出文件（Download Export）”作为价值闸门：
  - 未登录：弹出登录/注册（继续/返回不丢失识别结果）
  - 已登录但无导出权限：弹出升级/订阅引导（跳转到既有订阅流程）
  - 已登录且有权限：生成并下载对应模板文件（CSV/TXT）

B) 系统内模块能力（留存与扩展）
- 在系统内（登录后）提供“凭证列表 / OCR Inbox”页面：查看已识别的票据、状态、可重复导出、可批量导出（批量可作为 Phase1.5 或 Phase2，但至少预留结构）。
- 每条凭证具备：来源（try-ocr/系统内上传）、识别结构化结果、导出历史（导出过哪些模板、时间、下载人）。

C) 统一权限 + 用量计费
- OCR 识别用量：继续使用 Odoo 19 中央服务作为唯一事实来源扣减/计费（30 免费/月，超出 20 日元/张）。
- 导出下载权限：通过 entitlement 校验控制（Preview 允许，Download 受控）。
- 所有入口一致：try-ocr 与系统内上传都走相同的 document/usage/entitlement 模型。

# 2. 非目标（本期不做）
- 不重做 Stripe 产品与价格；只对接既有订阅/权限。
- 不实现复杂会计全链路（采购/应付/审批工作流）——只做到“识别→生成仕訳→模板导出”闭环。
- 不要求把所有税区分/科目表自动100%匹配：允许用户在导出前进行轻量修正（Minimal Edit），但必须保证导出文件格式正确、可导入率高。

# 3. 总体设计（你需要输出）
请输出完整设计与实现方案，至少包括：

## 3.1 领域模型（建议落地到 DB）
- Document（凭证/票据）
- OcrResult（结构化识别结果）
- CanonicalJournal（标准化仕訳中间格式，建议 JSON + 可展开行）
- ExportJob / ExportFile（导出记录：target=freee|mf|yayoi，文件路径，checksum，创建人，创建时间）
- UsageLedger（可选：本地缓存用量事件，但最终以 Odoo 中央服务为准）
- EntitlementCache（可选：短缓存，避免每次点击都打中央服务；需要 TTL 与回源）

说明字段定义、主键、索引（按 tenant_id / user_id / created_at / status）。

## 3.2 API 契约（前后端对齐）
至少提供：
- POST /api/ocr/recognize (已有则复用)：返回 document_id + 结构化结果摘要
- GET /api/documents/:id : 获取 document + ocr + canonical + 导出历史
- POST /api/export/preview : 入参 {document_id, target}，出参 {columns, rowsSample, warnings}
- POST /api/export/download : 入参 {document_id, target}，流程：
  1) 校验登录
  2) entitlement 校验（导出权限）
  3) 必要时触发 canonical 生成/修正
  4) 生成文件 -> S3 -> 返回签名下载 URL（或直接 stream）
  5) 记录 ExportFile
- POST /api/entitlements/check : （可选）封装对 Odoo 中央服务的校验
- POST /api/usage/consume : （可选）封装识别用量扣减（若 recognize 已做则不重复）

要求：所有 API 给出 request/response JSON schema、错误码规范（401/403/422/429/500），以及前端对应的用户提示文案。

## 3.3 导出器（Exporter）实现
实现 canonical -> target template 的插件化架构：
- exporters/freee.ts
- exporters/moneyforward.ts
- exporters/yayoi.ts

每个 exporter 必须包含：
- columns(): string[]  （模板列名）
- buildRows(canonical): string[][] （生成行）
- validate(canonical): warnings[] （缺税区分/贷借不平衡/金额为0等）
- fileFormat: csv or txt，encoding（日本环境建议 Shift_JIS 可选；至少提供 UTF-8 + BOM 方案并可配置）

注意点：
- freee：需要输出符合其“仕訳CSV模板”的列结构（包含 [明細行] 常量列的处理）。
- MoneyForward：需要支持“仕訳帳”导入常见列（至少：取引No/取引日/借方科目/贷方科目/税区分/金額/摘要；其它列可先留空）。
- 弥生：需要支持“識別フラグ”表达单行/多行仕訳（本期先实现单行仕訳即可，但接口要允许多行扩展）。

说明：由于我们不在本 prompt 中提供各厂商完整字段表，请你将“列定义”写成可配置映射（json/ts 常量），并在代码中加 TODO 与注释，便于后续补齐字段。重点是架构可扩展与端到端跑通。

## 3.4 Canonical（标准中间格式）生成策略
从 OCR 结果生成 canonical 仕訳（最小可用）：
- 默认：借方=消耗品費/会議費/旅費交通費 等候选（可按票据类型/关键词做启发式）
- 贷方=現金/普通預金/クレジットカード 等（可从支付方式推断）
- 税区分/税率：从票面10%/8%/対象外推断；无法推断则标记 warning 并要求用户在导出前选择
- 摘要：商户名 + 简述

需要提供“导出前最小编辑（Minimal Edit）”：
- UI 允许用户改：日期、科目（借/贷）、税区分、摘要、部门（可选）
- 修改结果写回 canonical（并记录修改人/时间）

## 3.5 前端改造（Next.js 假设；若你的技术栈不同请适配）
需要输出：
- Try OCR 页面改造：
  - ExportTargetSelector（freee/MF/弥生）
  - ExportPreviewTable（列名+样例行）
  - Download CTA（AuthGate + PaywallGate）
  - 登录弹窗/升级弹窗的交互流程（不丢失识别结果）
- 系统内页面新增：
  - /documents（OCR Inbox 列表）
  - /documents/:id（详情+预览+导出+历史）
- 权限与状态展示：
  - 展示“本月剩余免费识别张数/超额单价”
  - 导出权限状态（可导出哪些目标）

## 3.6 对接 Odoo 19 中央服务（计费/权限）
请输出一套清晰的对接方式（不需要你写 Odoo 端业务逻辑，但要写调用方式与本地封装）：
- Entitlement 校验：checkExportEntitlement(user, tenant, target)
- Usage 扣减：consumeOcrUsage(user, tenant, document_id)
- 重试与熔断：中央服务异常时，预览可以继续（读缓存），下载必须严格校验（Fail Closed）。

## 3.7 安全与合规
- 文件下载：S3 私有桶 + 短时效 signed URL
- 敏感字段：票据图片与导出文件都属于财务数据，必须记录 audit log（至少：谁在何时导出了哪个 document 的哪种模板）
- 速率限制：避免被滥用（Try OCR 未登录也要有基础 rate limit）
- 数据保留策略：导出文件可设置 7/30/90 天保留（可配置）

## 3.8 可观测性与验收标准
- 埋点事件：upload_started, ocr_success, exporter_selected, preview_loaded, download_clicked, auth_completed, paywall_view, export_generated, export_downloaded
- 关键指标：preview->signup, signup->first_download, download_success_rate
- 自动化测试：exporters 单元测试（给 3 个 canonical fixture），API 契约测试，前端 e2e（至少 try-ocr 流程）

# 4. 输出要求（Claude 交付物）
请直接输出以下内容（必须具体到文件路径/函数签名/伪代码/任务顺序）：
1) 架构图（ASCII） + 数据流
2) DB/数据结构定义（Prisma/SQL/TypeORM 任一，按现有项目栈）
3) API 契约（OpenAPI-like 简化版即可）
4) 前端组件拆分与路由（含状态机：未登录/无权限/有权限）
5) 导出器代码骨架（TypeScript 伪代码或可直接运行的实现）
6) Odoo 中央服务对接封装（client.ts）
7) 分阶段实施计划：
   - Phase0：最小跑通（preview + download gate）
   - Phase1：系统内 inbox + 导出历史
   - Phase2：批量导出 + 规则映射
8) 每个 Phase 的验收清单（Given/When/Then）

# 5. 约束（不要问我问题，做合理假设）
- 假设前端为 Next.js（App Router）+ TypeScript
- 假设后端为 Next.js API route 或独立 Node 服务（你自行选择最贴合现状的方式，但要一致）
- 假设我们已有用户系统与 tenant 概念
- 任何不确定项请用“合理默认 + TODO”处理，不要反问。
