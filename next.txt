# Claude Code 指令：Seisei BizNexus 引流 MVP（Landing + Public OCR + Claim + GA4）

你是资深全栈工程师。请在不破坏现有业务的前提下，实现一个端到端 MVP：
- seisei.tokyo 增加一个公开落地页（Receipt/Invoice OCR → Voucher Draft）
- 落地页 CTA 跳转到 biznexus.seisei.tokyo 的 public OCR 模式
- public OCR 支持未登录上传真实文件（TEN-PUBLIC），生成 OCR 结果与凭证草稿（Odoo Invoicing: account.move 草稿）
- 点击“保存/继续”触发登录；登录成功后 Claim：把 TEN-PUBLIC 的处理结果迁移/复制到用户租户，并创建用户租户下的 account.move 草稿
- 完成后跳转到 biznexus /billing 的详情页（票据中心详情）
- 同时完成 GA4 跨域/事件埋点（seisei → biznexus 的归因不断裂），核心 KPI 事件为 save_success

========================
0. 约束与既有系统
========================
- Frontend: Next.js 16.1 App Router (src/app), React 19, TS5, Tailwind v4, Zustand, TanStack Query, Zod
- Auth: 自研 JWT (jose), Google OAuth 自研, 邮箱+密码登录（Next.js 调 Odoo JSON-RPC /web/session/authenticate）
- OCR: Odoo 模型 ocr.file.task / ocr.file.source / ocr.file.usage (check_quota, increment_usage)
- Storage: S3 presigned upload; key rule: [tenantId]/[category]/[yyyy]/[mm]/[uuid].[ext]
- Public tenant 固定: TEN-PUBLIC
- public 配额: 每 anon_session 每日 3 次
- “票据中心”实现：基于 Odoo Invoicing/account.move 草稿；产品页入口 https://biznexus.seisei.tokyo/billing
- 完成后跳转：票据中心详情（在 /billing 下的详情路由）

========================
1. 交付物概览（必须完成）
========================
A) seisei.tokyo
1) 新增落地页：/tools/receipt-to-voucher (日文为主，可保留 EN/中文占位)
2) CTA 按钮跳转到：
   https://biznexus.seisei.tokyo/ocr?mode=public&type=receipt&utm_source=seisei&utm_medium=site&utm_campaign=ocr_mvp

B) biznexus.seisei.tokyo
3) /ocr 页面支持 mode=public, type=receipt|vendor_invoice 等
4) Public 模式未登录可上传文件，tenant 固定 TEN-PUBLIC
5) Public 模式调用 Odoo：
   - check_quota / increment_usage（按 anon_session 粒度）
   - 创建 ocr.file.source + ocr.file.task，启动识别
   - 将识别结果用于生成凭证草稿（account.move draft）【MVP 可先在 TEN-PUBLIC 下生成草稿 move】
6) 结果页显示凭证草稿预览；点击“保存并继续”触发登录（Google 或密码）
7) 登录成功后执行 Claim：
   - 以用户 tenant 创建新的 account.move 草稿（复制 TEN-PUBLIC 草稿 move 的关键字段或用同一结构化结果再生成一次）
   - 附件：将 public S3 object copy 到用户 tenant key
8) 保存成功后跳转到 /billing 的详情页（如 /billing/[id] 或 /billing?open=ID 以现有路由为准）
9) GA4 事件埋点：seisei + biznexus 全链路
   - 转化事件：save_success
   - 诊断事件：public_session_start, upload_success, ocr_parse_success, voucher_generate_success, claim_success, auth_success

========================
2. 技术设计（必须实现）
========================
2.1 匿名会话（anon_session）
- 新建 cookie: anon_session_id（uuid）
- 新建 API:
  - GET/POST /api/public/session: 创建或返回现有 anon_session，并返回 quota_remaining（每日3次）
- anon_session 计数存储：优先使用 Odoo 的 ocr.file.usage（TEN-PUBLIC + anon_session_id 作为 usage key）
  - 若 ocr.file.usage 不支持 anon_session 粒度，则在 Next.js 新增一个轻量 KV 存储（sqlite/redis/内存 + TODO）：
    anon_sessions(id, date, quota_used, ip_hash, ua_hash)

2.2 S3 上传（public）
- 复用现有 presigned URL 逻辑，但 tenantId 固定为 TEN-PUBLIC，category=documents 或 ocr
- 新建 API: POST /api/public/presign
  input: fileName, fileType, size, docType
  output: presignedUrl, s3Key, expiresIn
- 保存 s3Key 与 job 关联（anon_session_id + job_id）

2.3 Odoo 调用（public）
- 新建 API: POST /api/public/ocr/start
  input: anon_session_id, s3Key, docType, fileMeta
  actions:
   1) check_quota (TEN-PUBLIC + anon_session_id) -> reject if exceed 3/day
   2) create ocr.file.source with s3Key
   3) create ocr.file.task with source + docType + start
   4) increment_usage
  output: odoo_task_id, job_id
- 新建 API: GET /api/public/ocr/status?job_id=...
  - poll task status until parsed + draft ready
- 生成凭证草稿（MVP）
  - 如果当前系统已在 ocr.file.task 流程中生成 account.move draft，则读取该 move 并返回预览
  - 否则：用结构化结果直接创建 account.move 草稿（TEN-PUBLIC）：
    account.move.create({ move_type:'entry' or 'in_invoice' based on docType, invoice_date, partner_id(optional), line_ids, tax... })
  - 返回 draft_move_id 与预览 JSON

2.4 Auth + Claim
- public 模式下允许看到结果，但保存按钮触发登录
- 登录成功后，调用 POST /api/auth/claim
  input: anon_session_id, job_id, desired_target='billing'
  actions:
   1) 获取 public job 对应的 draft_move（TEN-PUBLIC）与 s3Key
   2) 将 S3 object copy 到用户 tenant key:
      TEN-XXX/document/yyyy/mm/uuid.ext
   3) 在用户 tenant 创建新的 account.move 草稿（优先复用 public draft_move 的字段；若不安全则用结构化结果再生成一次）
   4) 将附件关联到该 account.move（按你现有附件机制：ir.attachment 或自研）
  output: new_move_id
- response: redirect to /billing detail page:
  - 若现有为 /billing/[id] 则 push(`/billing/${new_move_id}`)
  - 若现有为 /billing?open=id 则 push(`/billing?open=${new_move_id}`)

========================
3. 前端改动点（文件级）
========================
3.1 seisei.tokyo（营销站）
- 新增页面：
  - src/app/tools/receipt-to-voucher/page.tsx
内容要求：
  - 日文标题：領収書・請求書をスキャンして仕訳を自動作成
  - 3 步说明：アップロード → 自動抽出 → 仕訳下書き
  - CTA 按钮：無料で試す（3回/日）
  - CTA 链接带 UTM 到 biznexus /ocr?mode=public&type=receipt...
  - 埋点：cta_click（见 GA 部分）

3.2 biznexus 产品站
- 修改 /ocr 页面（如 src/app/ocr/page.tsx 或相关子路由）
  - 解析 searchParams: mode, type, utm_*
  - public 模式：
     - 首次进入调用 /api/public/session，获取 anon_session_id 与 quota_remaining
     - 上传按钮调用 /api/public/presign -> 直传 S3 -> /api/public/ocr/start
     - 轮询 /api/public/ocr/status 获取结果 + draft 预览
     - “保存并继续”按钮：若未登录弹登录；登录成功后调用 /api/auth/claim
  - 非 public 模式（已登录）：保持原逻辑不变
  - UI 文案（日文）：
     - 免费提示：無料で1日3回お試しできます（保存は登録後）
     - 保存按钮：保存して続行（無料登録）
     - 次のアクション：仕入請求書/経費への変換は v2（MVP 先只做 billing 草稿）

- 新增一个轻量登录弹窗组件（若已有则复用）：
  - 支持 Google OAuth 与邮箱密码
  - 登录成功触发 auth_success 事件，并继续 claim

========================
4. GA4 埋点（必须）
========================
采用 gtag 或 GTM，但事件命名必须一致。实现一个通用函数 track(eventName, params)。

事件列表：
A) seisei.tokyo
- cta_click: {cta_id:'lp_receipt_to_voucher', dest_type:'public_ocr', doc_type:'receipt'}

B) biznexus public OCR
- public_session_start: {doc_type, utm_source, utm_medium, utm_campaign}
- ocr_start: {doc_type}
- upload_success: {file_type, file_size_kb, num_pages}
- ocr_parse_success: {processing_time_ms, confidence}
- voucher_generate_success: {latency_ms, has_tax_split}
- save_click: {target:'billing'}
- auth_start: {method:'google'|'password'}
- auth_success: {method}
- claim_success: {target:'billing'}
- save_success: {target:'billing'}   <-- 标记为 conversion

要求：
- 在 mode=public 首次 session 创建后触发 public_session_start
- 在关键步骤响应成功时触发各事件

========================
5. 验收标准（必须）
========================
1) seisei.tokyo 落地页可访问，CTA 正确跳转至 biznexus public OCR，并保留 UTM
2) 未登录用户可在 public 模式上传（TEN-PUBLIC），完成 OCR，并看到 draft 预览
3) public 每日 3 次限制生效，超限显示友好提示 + 引导注册
4) 点击保存触发登录；登录成功后 claim 创建用户 tenant 的 account.move 草稿并复制附件
5) 页面跳转到 /billing 详情页并能看到该草稿记录
6) GA4 可看到 save_success 转化，并能通过 source/medium 追踪到 seisei.tokyo

========================
6. 实施顺序建议
========================
- 先做 seisei 落地页 + 跳转 + GA cta_click
- 再做 biznexus public session + presign + ocr.start/status
- 再做结果预览 + 保存触发登录
- 最后做 claim + billing 详情跳转
- 全程补齐 GA 事件

开始编码前先扫描现有代码，找到：
- 现有 /ocr 页面与上传逻辑
- 现有 presign 逻辑位置
- 现有登录弹窗/登录页面与 JWT 签发逻辑
- /billing 页面详情路由结构
并尽量复用现有组件与函数，避免重写。
