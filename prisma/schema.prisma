// Prisma Schema for Seisei BizNexus
// Multi-tenant architecture with Odoo 18 CE integration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Tenant Management
// ============================================

model Tenant {
  id            String   @id @default(cuid())
  tenantCode    String   @unique @map("tenant_code") // TEN-xxxxxx
  name          String
  odooBaseUrl   String   @map("odoo_base_url")
  odooDb        String   @map("odoo_db")
  companyId     Int?     @map("company_id")
  warehouseId   Int?     @map("warehouse_id")
  planCode      String   @default("basic") @map("plan_code") // basic, standard, premium
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  features      TenantFeature[]
  users         User[]
  sessions      Session[]

  @@map("tenants")
}

// ============================================
// User Management
// ============================================

model User {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  odooUserId    Int      @map("odoo_user_id")
  odooLogin     String   @map("odoo_login")
  displayName   String   @map("display_name")
  email         String?
  isAdmin       Boolean  @default(false) @map("is_admin")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessions      Session[]
  modulePrefs   UserModulePref[]

  @@unique([tenantId, odooUserId])
  @@map("users")
}

// ============================================
// Session Management
// ============================================

model Session {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  tenantId        String   @map("tenant_id")
  odooSessionId   String   @map("odoo_session_id") // Encrypted Odoo session
  expiresAt       DateTime @map("expires_at")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ============================================
// Feature / Module Management
// ============================================

// Modules available for subscription
enum ModuleCode {
  POS
  INVENTORY
  PURCHASE
  SALES
  CRM
  EXPENSES
  ACCOUNTING
  FINANCE
  APPROVALS
  HR
  MAINTENANCE
  DOCUMENTS
  DASHBOARD
  PRODUCTS
}

// Tenant-level feature flags (subscription-based)
model TenantFeature {
  id          String     @id @default(cuid())
  tenantId    String     @map("tenant_id")
  moduleCode  ModuleCode @map("module_code")
  isAllowed   Boolean    @default(true) @map("is_allowed")
  isVisible   Boolean    @default(true) @map("is_visible") // Tenant admin can hide
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, moduleCode])
  @@map("tenant_features")
}

// User-level module preferences
model UserModulePref {
  id          String     @id @default(cuid())
  userId      String     @map("user_id")
  moduleCode  ModuleCode @map("module_code")
  isVisible   Boolean    @default(true) @map("is_visible")
  sortOrder   Int        @default(0) @map("sort_order")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleCode])
  @@map("user_module_prefs")
}

// ============================================
// OCR Cache & Rate Limiting
// ============================================

model OcrCache {
  id          String   @id @default(cuid())
  hash        String   @unique  // SHA256 of image
  result      Json     // OCR result
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("ocr_cache")
}

model OcrRateLimit {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  userId      String   @map("user_id")
  date        String   // YYYY-MM-DD
  requestCount Int     @default(0) @map("request_count")
  lastRequest DateTime @default(now()) @map("last_request")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, userId, date])
  @@map("ocr_rate_limits")
}

// Monthly OCR usage for billing (per tenant)
model OcrMonthlyUsage {
  id                  String   @id @default(cuid())
  tenantId            String   @map("tenant_id")
  monthKey            String   @map("month_key") // YYYY-MM (JST)
  usedCount           Int      @default(0) @map("used_count")
  freeQuota           Int      @default(30) @map("free_quota")
  unitPriceJpy        Int      @default(10) @map("unit_price_jpy")
  firstOverageAt      DateTime? @map("first_overage_at")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, monthKey])
  @@map("ocr_monthly_usage")
}

// ============================================
// Cash Ledger Settings (per tenant)
// ============================================

model CashLedgerSettings {
  id                  String   @id @default(cuid())
  tenantId            String   @unique @map("tenant_id")
  cashJournalId       Int      @map("cash_journal_id")
  cashAccountId       Int      @map("cash_account_id")
  bankJournalIdToza   Int?     @map("bank_journal_id_toza")
  bankAccountIdToza   Int?     @map("bank_account_id_toza")
  bankJournalIdFutsu  Int?     @map("bank_journal_id_futsu")
  bankAccountIdFutsu  Int?     @map("bank_account_id_futsu")
  accountMappings     Json     @default("{}") @map("account_mappings") // categoryCode -> accountId
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@map("cash_ledger_settings")
}

// ============================================
// Expense Types
// ============================================

model ExpenseType {
  id          String   @id @default(cuid())
  code        String   @unique
  nameEn      String   @map("name_en")
  nameZh      String   @map("name_zh")
  nameJa      String   @map("name_ja")
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("expense_types")
}

// ============================================
// Subscription Plans (for reference)
// ============================================

model SubscriptionPlan {
  id              String   @id @default(cuid())
  planCode        String   @unique @map("plan_code")
  name            String
  allowedModules  String[] @map("allowed_modules") // Array of ModuleCode
  maxUsers        Int      @default(5) @map("max_users")
  priceMonthly    Decimal  @default(0) @map("price_monthly")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("subscription_plans")
}
