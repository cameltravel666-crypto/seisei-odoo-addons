<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!--
        Standalone Ordering Page Template
        ÂÆåÂÖ®Áã¨Á´ãÁöÑ HTML ÊñáÊ°£Ôºå‰∏ç‰ΩøÁî®‰ªª‰Ωï Odoo Ê®°ÊùøÔºåÈÅøÂÖç #wrapwrap ÈóÆÈ¢ò
    -->
    <template id="ordering_page" name="QR Ordering Page Standalone">
        <t t-set="html_data" t-value="{}"/>
        <html>
            <head>
                <meta charset="utf-8"/>
                <!-- viewport-fit=cover ÊîØÊåÅ iPhone X+ ÁöÑ safe area -->
                <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
                <meta name="theme-color" content="#ff6b35"/>
                <!-- Èò≤Ê≠¢ iOS Ëá™Âä®Ê£ÄÊµãÁîµËØùÂè∑Á†Å -->
                <meta name="format-detection" content="telephone=no"/>
                <title>Êâ´Á†ÅÁÇπÈ§ê</title>

                <!-- ÁßªÂä®Á´ØÂÖúÂ∫ï CSSÔºöËß£ÂÜ≥ iOS Safari / ÂæÆ‰ø°ÊµèËßàÂô®È´òÂ∫¶ÈóÆÈ¢ò -->
                <style type="text/css">
                    /* P0: ‰∏âÊÆµÂºèÂ∏ÉÂ±Ä - html/body ‰∏çÊªöÂä®ÔºàÂº∫Âà∂ÔºåÈò≤Ê≠¢ÂÖ®Â±Ä CSS Âπ≤Êâ∞Ôºâ */
                    html, body {
                        height: 100% !important;
                        margin: 0 !important;
                        padding: 0 !important;
                        /* ÈªòËÆ§‰∏çÈîÅÊªöÂä®ÔºÅÂè™Âú®ÂºπÂ±ÇÊâìÂºÄÊó∂ÈÄöËøá JS Ê∑ªÂä† .qr-scroll-locked */
                        overflow: visible !important;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        background: #f5f5f5;
                        /* Èò≤Ê≠¢ iOS ÂèåÂáªÁº©Êîæ */
                        touch-action: manipulation;
                        -webkit-tap-highlight-color: transparent;
                    }
                    /* P0: Êï¥È°µÂÆπÂô®Ôºà‰∏çÊªöÂä®Ôºâ- Âº∫Âà∂Â∏ÉÂ±Ä */
                    #qr-ordering-app {
                        width: 100% !important;
                        min-height: 100vh !important; /* fallback */
                        min-height: 100dvh !important; /* Âä®ÊÄÅËßÜÂè£È´òÂ∫¶ÔºåËá™Âä®ÈÄÇÂ∫îÂú∞ÂùÄÊ†è */
                        display: flex !important;
                        flex-direction: column !important;
                        position: relative !important;
                        overflow: hidden !important; /* È°µÈù¢ÂÆπÂô®‰∏çÊªöÂä® */
                    }
                    /* P0: ÂÜÖÂÆπÂå∫ÔºàÂîØ‰∏ÄÊªöÂä®ÂÆπÂô®Ôºâ- Âº∫Âà∂ÊªöÂä® */
                    .qr-content {
                        flex: 1 1 auto !important;
                        overflow-y: auto !important;
                        -webkit-overflow-scrolling: touch !important;
                    }
                    /* P0: Â∫ïÈÉ®Ê†èÔºàÊ∞∏ËøúÂèØËßÅÔºâ- Âº∫Âà∂ sticky */
                    .qr-bottom-bar {
                        position: sticky !important;
                        bottom: 0 !important;
                        z-index: 1000 !important;
                        display: flex !important;
                        visibility: visible !important;
                        padding-bottom: env(safe-area-inset-bottom, 0px) !important;
                    }
                </style>

                <!-- Âä†ËΩΩÁÇπÈ§êÈ°µ CSS -->
                <link type="text/css" rel="stylesheet" t-att-href="'/qr_ordering/static/src/css/qr_ordering.css?v=' + (build_version or 'dev')"/>
            </head>
            <body>
                <!-- Boot Guard: Èò≤Ê≠¢ÁôΩÂ±èÁöÑÂÖúÂ∫ïÊú∫Âà∂ -->
                <div id="qr-boot-guard" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #fff; z-index: 99999; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px;">
                    <div style="text-align: center; max-width: 400px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üçΩÔ∏è</div>
                        <h1 style="font-size: 24px; margin-bottom: 10px; color: #333;">Ê≠£Âú®Âä†ËΩΩ...</h1>
                        <p style="color: #666; margin-bottom: 20px;">Â¶ÇÊûú 3 ÁßíÂêé‰ªçÊú™ÊòæÁ§∫ËèúÂçïÔºåËØ∑Âà∑Êñ∞È°µÈù¢</p>
                        <p style="font-size: 12px; color: #999;">Build: <t t-esc="build_version or 'unknown'"/></p>
                    </div>
                </div>

                <!-- Debug Panel (only when debug=1) -->
                <t t-if="debug_mode">
                    <div id="qr-debug-panel" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.85); color: #0f0; padding: 10px; font-size: 11px; font-family: monospace; z-index: 100000; border-radius: 4px; max-width: 300px;">
                        <div style="font-weight: bold; margin-bottom: 5px; color: #fff;">QR Ordering Debug</div>
                        <div>Build: <span id="qr-debug-build"><t t-esc="build_version or 'unknown'"/></span></div>
                        <div>Trace: <span id="qr-debug-trace"><t t-esc="trace_id or 'N/A'"/></span></div>
                        <div>JS: <span id="qr-debug-js">checking...</span></div>
                        <div>API: <span id="qr-debug-api">pending...</span></div>
                    </div>
                </t>

                <!-- ‰∏ªÂ∫îÁî®ÂÆπÂô® - P0: ‰∏âÊÆµÂºèÂ∏ÉÂ±Ä -->
                <div id="qr-ordering-app"
                     class="qr-page"
                     t-att-data-table-token="table.qr_token"
                     t-att-data-access-token="access_token"
                     t-att-data-table-name="table.name"
                     t-att-data-lang="lang">

                    <!-- Header -->
                    <header class="qr-header">
                        <div class="qr-header-left">
                            <span class="qr-table-name" t-esc="table.name"/>
                        </div>
                        <div class="qr-header-center">
                            <span class="qr-logo">üçΩÔ∏è</span>
                        </div>
                        <div class="qr-header-right">
                            <select id="qr-lang-select" class="qr-lang-select">
                                <option value="zh_CN" t-att-selected="lang == 'zh_CN' and 'selected' or None">‰∏≠Êñá</option>
                                <option value="ja_JP" t-att-selected="lang == 'ja_JP' and 'selected' or None">Êó•Êú¨Ë™û</option>
                                <option value="en_US" t-att-selected="lang == 'en_US' and 'selected' or None">English</option>
                            </select>
                        </div>
                    </header>

                    <!-- Main Content -->
                    <main class="qr-main">
                        <!-- Left Sidebar: Categories -->
                        <aside class="qr-sidebar">
                            <div class="qr-categories" id="qr-categories">
                                <div class="qr-category active" data-category-id="all">
                                    <span class="qr-category-icon">üìã</span>
                                    <span class="qr-category-name" data-i18n="all">ÂÖ®ÈÉ®</span>
                                </div>
                            </div>
                        </aside>

                        <!-- Right Content: Products -->
                        <section class="qr-content">
                            <div class="qr-search-bar">
                                <input type="text" id="qr-search-input" class="qr-search-input"
                                       placeholder="ÊêúÁ¥¢ËèúÂìÅ..." data-i18n-placeholder="search"/>
                            </div>
                            <div class="qr-products" id="qr-products">
                                <div class="qr-loading">
                                    <div class="qr-spinner"></div>
                                    <p data-i18n="loading">Âä†ËΩΩ‰∏≠...</p>
                                </div>
                            </div>
                        </section>
                    </main>

                    <!-- Â∫ïÈÉ®Ê†è - ÂõõÊÄÅÁä∂ÊÄÅÊú∫ -->
                    <footer class="qr-bottom-bar" id="qr-cart-footer">
                        <!-- Â∑¶‰æßÔºöÂ∑≤ÈÄâÂõæÊ†á + ÈáëÈ¢ù/‰ª∂Êï∞ -->
                        <div class="qr-cart-summary" id="qr-cart-summary">
                            <div class="qr-cart-icon" id="qr-cart-icon-btn">
                                <span class="qr-cart-badge" id="qr-cart-badge">0</span>
                                üçΩÔ∏è
                            </div>
                            <div class="qr-cart-info">
                                <span class="qr-cart-amount" id="qr-cart-amount">¬•0</span>
                                <span class="qr-cart-count" id="qr-cart-count">0 ‰ªΩ</span>
                            </div>
                        </div>
                        <!-- ‰∏≠Èó¥ÔºöËÆ¢ÂçïÁä∂ÊÄÅÂæΩÁ´†ÔºàÂ∑≤‰∏ãÂçïÊó∂ÊòæÁ§∫Ôºâ -->
                        <div class="qr-order-status-badge" id="qr-order-status-badge" style="display: none;">
                            <span class="qr-status-text" id="qr-status-text">Â∑≤‰∏ãÂçï ¬∑ #---</span>
                        </div>
                        <!-- Âè≥‰æßÔºö‰∏ªÊ¨°‰∏§‰∏™ÊåâÈíÆ -->
                        <div class="qr-footer-buttons">
                            <!-- Ê¨°ÊåâÈíÆÔºàÊü•ÁúãÂ∑≤ÈÄâ/Êü•ÁúãÂ∑≤ÁÇπÔºâ -->
                            <button class="qr-cart-btn secondary" id="qr-secondary-btn">Êü•ÁúãÂ∑≤ÈÄâ</button>
                            <!-- ‰∏ªÊåâÈíÆÔºà‰∏ãÂçï/ËøΩÂä†‰∏ãÂçï/Âéª‰π∞ÂçïÔºâ -->
                            <button class="qr-cart-btn primary" id="qr-primary-btn" disabled="disabled">‰∏ãÂçï</button>
                        </div>
                        <!-- Áä∂ÊÄÅ A ÊèêÁ§∫ËØ≠ -->
                        <div class="qr-footer-hint" id="qr-footer-hint" style="display: none;">ËØ∑ÈÄâÊã©ËèúÂìÅ</div>
                    </footer>

                    <!-- ÂâçÂè∞‰π∞ÂçïÂºπÁ™ó -->
                    <div class="qr-modal" id="qr-pay-modal">
                        <div class="qr-modal-content qr-pay-content">
                            <div class="qr-pay-header">
                                <h2 data-i18n="pay_title">üí≥ ÂâçÂè∞‰π∞Âçï</h2>
                                <button class="qr-modal-close" id="qr-pay-close">√ó</button>
                            </div>
                            <div class="qr-pay-body">
                                <p class="qr-pay-instruction" data-i18n="pay_instruction">ËØ∑Âà∞ÂâçÂè∞Âá∫Á§∫‰ª•‰∏ã‰ø°ÊÅØÂÆåÊàê‰π∞Âçï</p>
                                <div class="qr-pay-info">
                                    <div class="qr-pay-row">
                                        <span class="qr-pay-label" data-i18n="pay_table">Ê°åÂè∑</span>
                                        <span class="qr-pay-value" id="qr-pay-table">---</span>
                                        <button class="qr-copy-btn" id="qr-copy-table" data-i18n="copy">Â§çÂà∂</button>
                                    </div>
                                    <div class="qr-pay-row">
                                        <span class="qr-pay-label" data-i18n="pay_order">ËÆ¢ÂçïÂè∑</span>
                                        <span class="qr-pay-value" id="qr-pay-order">---</span>
                                        <button class="qr-copy-btn" id="qr-copy-order" data-i18n="copy">Â§çÂà∂</button>
                                    </div>
                                    <!-- ÈáëÈ¢ùÊòéÁªÜÔºöÊú™Á®éÈáëÈ¢ù / Á®éÈ¢ù / Âê´Á®éÂêàËÆ° -->
                                    <div class="qr-pay-row qr-pay-amount-row">
                                        <span class="qr-pay-label" data-i18n="pay_subtotal">Êú™Á®éÈáëÈ¢ù</span>
                                        <span class="qr-pay-value" id="qr-pay-subtotal">¬•0</span>
                                    </div>
                                    <div class="qr-pay-row qr-pay-amount-row">
                                        <span class="qr-pay-label" data-i18n="pay_tax">Á®éÈ¢ù</span>
                                        <span class="qr-pay-value" id="qr-pay-tax">¬•0</span>
                                    </div>
                                    <div class="qr-pay-row qr-pay-total-row">
                                        <span class="qr-pay-label" data-i18n="pay_total_incl_tax">Âê´Á®éÂêàËÆ°</span>
                                        <span class="qr-pay-value qr-pay-amount" id="qr-pay-amount">¬•0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="qr-pay-footer">
                                <button class="qr-cart-btn secondary" id="qr-pay-done" data-i18n="done">ÊàëÁü•ÈÅì‰∫Ü</button>
                            </div>
                        </div>
                    </div>

                    <!-- Product Detail Modal -->
                    <div class="qr-modal" id="qr-product-modal">
                        <div class="qr-modal-content">
                            <button class="qr-modal-close" id="qr-modal-close">√ó</button>
                            <div class="qr-product-detail" id="qr-product-detail"></div>
                        </div>
                    </div>

                    <!-- Â∑≤ÈÄâËèúÂìÅ Modal -->
                    <div class="qr-modal" id="qr-cart-modal">
                        <div class="qr-modal-content qr-cart-content">
                            <div class="qr-cart-header">
                                <h2 data-i18n="cart">Â∑≤ÈÄâËèúÂìÅ</h2>
                                <button class="qr-modal-close" id="qr-cart-close">√ó</button>
                            </div>
                            <div class="qr-cart-items" id="qr-cart-items"></div>
                            <div class="qr-cart-note">
                                <textarea id="qr-cart-note" placeholder="Â§áÊ≥®ÔºàÂøåÂè£„ÄÅÂè£Âë≥Á≠âÔºâ..." data-i18n-placeholder="note_placeholder"></textarea>
                            </div>
                            <div class="qr-cart-actions">
                                <div class="qr-cart-total-row">
                                    <span data-i18n="total">Â∞èËÆ°</span>:
                                    <span class="qr-cart-total-amount" id="qr-cart-total-amount">¬•0</span>
                                </div>
                                <button class="qr-submit-btn" id="qr-submit-order-btn" data-i18n="submit_order">‰∏ãÂçï</button>
                            </div>
                        </div>
                    </div>

                    <!-- Â∑≤ÁÇπËèúÂìÅ Modal -->
                    <div class="qr-modal" id="qr-order-modal">
                        <div class="qr-modal-content qr-order-content">
                            <div class="qr-order-header">
                                <h2 data-i18n="my_orders">Â∑≤ÁÇπËèúÂìÅ</h2>
                                <button class="qr-modal-close" id="qr-order-close">√ó</button>
                            </div>
                            <div class="qr-order-list" id="qr-order-list"></div>
                            <div class="qr-order-actions">
                                <button class="qr-add-more-btn" id="qr-add-more-btn" data-i18n="add_more">ÁªßÁª≠ÁÇπÈ§ê</button>
                            </div>
                        </div>
                    </div>

                    <!-- Toast Notification -->
                    <div class="qr-toast" id="qr-toast">
                        <span id="qr-toast-message"></span>
                    </div>

                    <!-- ËÆ¢ÂçïÁä∂ÊÄÅ ToastÔºàÁÇπÂáª chip Êàñ‰∏ãÂçïÊàêÂäüÊó∂Â±ïÁ§∫Ôºâ -->
                    <div class="qr-order-toast" id="qr-order-toast">
                        <div class="qr-order-toast-header">
                            <div class="qr-order-toast-title">
                                <span class="qr-toast-icon">‚úÖ</span>
                                <span id="qr-order-toast-title">ËÆ¢ÂçïÂ∑≤Êèê‰∫§</span>
                            </div>
                            <button class="qr-order-toast-close" id="qr-order-toast-close">√ó</button>
                        </div>
                        <div class="qr-order-toast-body">
                            <div class="qr-order-toast-row">
                                <span class="qr-order-toast-label">ËÆ¢ÂçïÂè∑</span>
                                <span class="qr-order-toast-value">
                                    <span id="qr-order-toast-ref">---</span>
                                    <button class="qr-order-toast-copy" id="qr-order-toast-copy-ref">Â§çÂà∂</button>
                                </span>
                            </div>
                            <div class="qr-order-toast-row">
                                <span class="qr-order-toast-label">Ê°åÂè∑</span>
                                <span class="qr-order-toast-value" id="qr-order-toast-table">---</span>
                            </div>
                            <div class="qr-order-toast-row" id="qr-order-toast-hint-row" style="display: none;">
                                <span class="qr-order-toast-label" style="color: #2e7d32;">ÂèØÁªßÁª≠ÁÇπÈ§êËøΩÂä†Âà∞Âêå‰∏ÄËÆ¢Âçï</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Boot Guard Script: ËØäÊñ≠ËÑöÊú¨ÊâßË°åÁä∂ÊÄÅ -->
                <script type="text/javascript">
                (function() {
                    'use strict';

                    window.__qrDiag = {
                        qrOrderingLoaded: false,
                        initComplete: false,
                        errors: [],
                        traceId: '<t t-esc="trace_id or 'N/A'"/>'
                    };

                    var bootGuard = document.getElementById('qr-boot-guard');
                    var qrApp = document.getElementById('qr-ordering-app');
                    var debugPanel = document.getElementById('qr-debug-panel');

                    function showBootError(title, detail, errorCode) {
                        window.__qrDiag.errors.push({code: errorCode, title: title, detail: detail, time: new Date().toISOString()});
                        if (!bootGuard) return;
                        bootGuard.innerHTML =
                            '<div style="text-align:center;max-width:400px;padding:20px;">' +
                                '<div style="font-size:48px;margin-bottom:20px;">‚ö†Ô∏è</div>' +
                                '<h1 style="font-size:20px;margin-bottom:10px;color:#333;">' + title + '</h1>' +
                                '<p style="color:#666;margin-bottom:15px;font-size:14px;">' + detail + '</p>' +
                                '<button onclick="location.reload()" style="padding:12px 24px;background:#ff6b35;color:white;border:none;border-radius:4px;cursor:pointer;font-size:16px;">Âà∑Êñ∞È°µÈù¢</button>' +
                                '<p style="font-size:11px;color:#999;margin-top:20px;">ÈîôËØØ‰ª£Á†Å: ' + errorCode + '</p>' +
                                '<p style="font-size:11px;color:#999;">Trace ID: ' + window.__qrDiag.traceId + '</p>' +
                            '</div>';
                    }

                    function updateDebug(key, value, isError) {
                        if (!debugPanel) return;
                        var el = document.getElementById('qr-debug-' + key);
                        if (el) {
                            el.textContent = value;
                            el.style.color = isError ? '#ff4444' : '#44ff44';
                        }
                    }

                    function markInitialized() {
                        window.__qrDiag.initComplete = true;
                        if (bootGuard) bootGuard.style.display = 'none';
                        updateDebug('api', 'success', false);
                    }

                    window.addEventListener('qr-ordering-initialized', markInitialized);
                    window.__qrOrderingMarkInit = markInitialized;

                    // 1ÁßíÂêéÊ£ÄÊü• JS ÊòØÂê¶Âä†ËΩΩ
                    setTimeout(function() {
                        var qrLoaded = typeof window.QR_ORDERING_BUILD !== 'undefined';
                        window.__qrDiag.qrOrderingLoaded = qrLoaded;
                        if (!qrLoaded) {
                            updateDebug('js', 'NOT EXECUTED', true);
                            showBootError('ÁÇπÈ§êËÑöÊú¨Êú™ÊâßË°å', 'qr_ordering.js Êú™ËÉΩÂä†ËΩΩÊàñÊâßË°å', 'JS_NOT_EXECUTED');
                        } else {
                            updateDebug('js', 'v' + window.QR_ORDERING_BUILD, false);
                        }
                    }, 1000);

                    // 5ÁßíÂêéÊ£ÄÊü•ÂàùÂßãÂåñ
                    setTimeout(function() {
                        if (window.__qrDiag.initComplete) return;
                        var diag = window.__qrDiag;
                        if (!diag.qrOrderingLoaded) {
                            showBootError('ÁÇπÈ§êËÑöÊú¨Âä†ËΩΩÂ§±Ë¥•', 'ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÈáçËØï', 'QR_JS_FAILED');
                        } else {
                            showBootError('Êï∞ÊçÆÂä†ËΩΩË∂ÖÊó∂', 'ËèúÂçïÊï∞ÊçÆËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Âà∑Êñ∞ÈáçËØï', 'API_TIMEOUT');
                        }
                        updateDebug('api', 'TIMEOUT', true);
                    }, 5000);

                    window.addEventListener('error', function(e) {
                        var target = e.target;
                        if (target &amp;&amp; target.tagName === 'SCRIPT') {
                            var src = target.src || '';
                            if (src.indexOf('qr_ordering') !== -1) {
                                showBootError('JavaScript Âä†ËΩΩÂ§±Ë¥•', 'ÁÇπÈ§êËÑöÊú¨Êó†Ê≥ïÂä†ËΩΩ', 'JS_LOAD_ERROR');
                            }
                        }
                    }, true);
                })();
                </script>

                <!-- Áõ¥Êé•Âä†ËΩΩÁÇπÈ§ê JSÔºà‰∏çÈÄöËøá Odoo assetsÔºâ -->
                <script type="text/javascript" t-att-src="'/qr_ordering/static/src/js/qr_ordering.js?v=' + (build_version or 'dev')"></script>
            </body>
        </html>
    </template>
    
    <!-- Error Page Template -->
    <template id="error_page" name="QR Ordering Error">
        <t t-call="web.html_container">
            <head>
                <meta charset="UTF-8"/>
                <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
                <title>Êâ´Á†ÅÁÇπÈ§ê - ÈîôËØØ</title>
                <style>
                    * { box-sizing: border-box; margin: 0; padding: 0; }
                    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
                    .qr-error-page { width: 100%; max-width: 400px; padding: 40px 20px; text-align: center; }
                    .qr-error-icon { font-size: 64px; margin-bottom: 20px; }
                    .qr-error-title { font-size: 24px; font-weight: 600; color: #333; margin-bottom: 12px; }
                    .qr-error-message { font-size: 16px; color: #666; margin-bottom: 24px; line-height: 1.5; }
                    .qr-error-actions { margin-top: 20px; }
                    .qr-error-actions p { font-size: 14px; color: #666; margin-bottom: 16px; }
                    .qr-btn { display: inline-block; padding: 12px 32px; background: #ff6b35; color: white; text-decoration: none; border-radius: 8px; font-size: 16px; font-weight: 500; }
                    .qr-btn:hover { background: #e55a2b; }
                    .qr-error-trace { font-size: 12px; color: #999; margin-top: 20px; }
                </style>
            </head>
            <body>
                <div class="qr-error-page">
                    <div class="qr-error-icon">
                        <t t-if="error_code == 'TABLE_NOT_FOUND'">üîç</t>
                        <t t-elif="error_code == 'SYSTEM_ERROR'">‚ö†Ô∏è</t>
                        <t t-else="">üòï</t>
                    </div>
                    <h1 class="qr-error-title">
                        <t t-if="error_code == 'TABLE_NOT_FOUND'">È§êÊ°å‰∏çÂ≠òÂú®</t>
                        <t t-elif="error_code == 'SESSION_OCCUPIED'">ËØ•È§êÊ°åÂ∑≤Êúâ‰∫∫Âú®ÁÇπÈ§ê</t>
                        <t t-elif="error_code == 'SESSION_EXPIRED'">‰ºöËØùÂ∑≤ËøáÊúü</t>
                        <t t-elif="error_code == 'TABLE_HAS_ORDERS'">ËØ•È§êÊ°åÊúâÊú™ÂÆåÊàêÁöÑËÆ¢Âçï</t>
                        <t t-elif="error_code == 'SYSTEM_ERROR'">Á≥ªÁªüÁπÅÂøô</t>
                        <t t-else="">Âá∫Èîô‰∫Ü</t>
                    </h1>
                    <p class="qr-error-message" t-esc="error_message"/>
                    <div class="qr-error-actions">
                        <t t-if="error_code in ['SESSION_EXPIRED', 'SESSION_OCCUPIED']">
                            <p>ËØ∑ËÅîÁ≥ªÊúçÂä°ÂëòÂçèÂä©</p>
                        </t>
                        <t t-if="error_code == 'TABLE_NOT_FOUND'">
                            <p>Ê≠§‰∫åÁª¥Á†ÅÂèØËÉΩÂ∑≤Â§±ÊïàÔºåËØ∑ËÅîÁ≥ªÊúçÂä°ÂëòËé∑ÂèñÊñ∞ÁöÑ‰∫åÁª¥Á†Å</p>
                        </t>
                        <a href="javascript:location.reload()" class="qr-btn">ÈáçËØï</a>
                    </div>
                    <t t-if="trace_id">
                        <p class="qr-error-trace">
                            ÈîôËØØID: <t t-esc="trace_id"/>
                        </p>
                    </t>
                </div>
            </body>
        </t>
    </template>
    
    <!-- Print QR Code Page -->
    <template id="print_qr_page" name="Print QR Code">
        <t t-call="web.html_container">
            <div class="qr-print-page">
                <style>
                    .qr-print-page {
                        width: 100%;
                        max-width: 400px;
                        margin: 0 auto;
                        padding: 20px;
                        text-align: center;
                        font-family: Arial, sans-serif;
                    }
                    .qr-print-title {
                        font-size: 24px;
                        font-weight: bold;
                        margin-bottom: 10px;
                    }
                    .qr-print-subtitle {
                        font-size: 14px;
                        color: #666;
                        margin-bottom: 20px;
                    }
                    .qr-print-code {
                        margin: 20px auto;
                    }
                    .qr-print-table-name {
                        font-size: 36px;
                        font-weight: bold;
                        margin: 20px 0;
                        padding: 10px;
                        border: 3px solid #000;
                        display: inline-block;
                    }
                    .qr-print-instruction {
                        font-size: 16px;
                        margin-top: 20px;
                    }
                    @media print {
                        .no-print { display: none; }
                    }
                </style>
                
                <div class="qr-print-title">Êâ´Á†ÅÁÇπÈ§ê</div>
                <div class="qr-print-subtitle">Scan to Order</div>
                
                <div class="qr-print-code">
                    <!-- QR Code Image - ‰ªéÊéßÂà∂Âô®‰º†ÂÖ•ÂÆåÊï¥ URL -->
                    <img t-att-src="barcode_url" width="300" height="300" alt="QR Code"/>
                    <div style="font-size: 10px; color: #666; margin-top: 5px; word-break: break-all;" t-esc="qr_content_url"/>
                </div>
                
                <div class="qr-print-table-name" t-esc="table.name"/>
                
                <div class="qr-print-instruction">
                    ËØ∑Êâ´Êèè‰∫åÁª¥Á†ÅÁÇπÈ§ê<br/>
                    Please scan to order
                </div>
                
                <div class="no-print" style="margin-top: 30px;">
                    <button onclick="window.print()" class="btn btn-primary">ÊâìÂç∞ Print</button>
                </div>
            </div>
        </t>
    </template>

    <!-- Batch Print QR Codes Page ‚Äî Label Mode -->
    <template id="print_qr_batch_page" name="Batch Print QR Codes">
        <t t-call="web.html_container">
            <div class="qr-label-page">
                <!-- Dynamic @page style ‚Äî updated by JS -->
                <style id="qr-page-style">
                    @page { size: 62mm 62mm; margin: 3mm; }
                </style>

                <style>
                    /* ===== Base ===== */
                    .qr-label-page {
                        font-family: Arial, 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
                        margin: 0; padding: 0;
                    }

                    /* ===== Toolbar (screen only) ===== */
                    .qr-label-toolbar {
                        position: sticky; top: 0; z-index: 100;
                        background: #f8f9fa; border-bottom: 1px solid #ddd;
                        padding: 12px 16px;
                        display: flex; flex-wrap: wrap; align-items: center; gap: 12px;
                    }
                    .qr-label-toolbar label {
                        font-size: 13px; font-weight: 600; margin: 0;
                    }
                    .qr-label-toolbar input[type="number"] {
                        width: 60px; padding: 4px 6px; border: 1px solid #ccc;
                        border-radius: 4px; text-align: center; font-size: 13px;
                    }
                    .qr-label-toolbar .unit { font-size: 12px; color: #666; margin-right: 4px; }
                    .qr-label-presets { display: flex; gap: 4px; margin-left: 4px; }
                    .qr-label-presets button {
                        padding: 3px 8px; font-size: 11px; border: 1px solid #aaa;
                        border-radius: 3px; background: #fff; cursor: pointer;
                    }
                    .qr-label-presets button:hover { background: #e9ecef; }
                    .qr-label-presets button.active { background: #0d6efd; color: #fff; border-color: #0d6efd; }
                    .qr-label-toolbar .toolbar-sep {
                        width: 1px; height: 28px; background: #ccc; margin: 0 4px;
                    }
                    .qr-label-toolbar .btn { margin: 0; }
                    .qr-label-count {
                        font-size: 13px; color: #666; margin-left: auto;
                    }

                    /* ===== Screen preview: card list ===== */
                    .qr-label-list {
                        display: flex; flex-wrap: wrap; gap: 16px;
                        justify-content: center; padding: 20px;
                    }
                    .qr-label-card {
                        border: 1px dashed #999; border-radius: 4px;
                        display: flex; flex-direction: column;
                        align-items: center; justify-content: center;
                        box-sizing: border-box; overflow: hidden;
                        /* width/height set by JS via inline style */
                    }
                    .qr-label-title {
                        font-weight: bold; text-align: center;
                        line-height: 1.2; margin: 0;
                    }
                    .qr-label-img {
                        display: block; margin: 0 auto;
                    }
                    .qr-label-name {
                        font-weight: bold; text-align: center;
                        border: 2px solid #000; padding: 2px 8px;
                        display: inline-block; line-height: 1.2;
                    }
                    .qr-label-hint {
                        text-align: center; color: #333;
                        line-height: 1.2; margin: 0;
                    }

                    /* ===== Print: one label per page ===== */
                    @media print {
                        .qr-label-toolbar { display: none !important; }
                        .qr-label-page { padding: 0; }
                        .qr-label-list {
                            display: block; padding: 0; gap: 0;
                        }
                        .qr-label-card {
                            width: 100% !important; height: 100% !important;
                            border: none; border-radius: 0;
                            page-break-after: always;
                            margin: 0; padding: 0;
                        }
                        .qr-label-card:last-child {
                            page-break-after: auto;
                        }
                    }
                </style>

                <!-- Toolbar -->
                <div class="qr-label-toolbar no-print">
                    <label>ÂÆΩÂ∫¶:</label>
                    <input id="label-w" type="number" value="62" min="20" max="200" onchange="updatePageSize()" oninput="updatePageSize()"/>
                    <span class="unit">mm</span>

                    <label>È´òÂ∫¶:</label>
                    <input id="label-h" type="number" value="62" min="20" max="200" onchange="updatePageSize()" oninput="updatePageSize()"/>
                    <span class="unit">mm</span>

                    <label>ËæπË∑ù:</label>
                    <input id="label-m" type="number" value="3" min="0" max="20" onchange="updatePageSize()" oninput="updatePageSize()"/>
                    <span class="unit">mm</span>

                    <div class="qr-label-presets">
                        <button type="button" onclick="applyPreset(62,62,3)">62√ó62</button>
                        <button type="button" onclick="applyPreset(62,100,3)">62√ó100</button>
                        <button type="button" onclick="applyPreset(62,29,2)">62√ó29</button>
                        <button type="button" onclick="applyPreset(50,50,3)">50√ó50</button>
                    </div>

                    <div class="toolbar-sep"/>

                    <button type="button" onclick="window.print()" class="btn btn-primary btn-sm">
                        <i class="fa fa-print"/> ÊâìÂç∞
                    </button>
                    <button type="button" onclick="exportImages()" class="btn btn-success btn-sm">
                        <i class="fa fa-download"/> ÂØºÂá∫ÂõæÁâá
                    </button>
                    <button type="button" onclick="window.close()" class="btn btn-secondary btn-sm">
                        <i class="fa fa-times"/> ÂÖ≥Èó≠
                    </button>

                    <span class="qr-label-count">
                        ÂÖ± <t t-esc="len(tables_data)"/> ‰∏™Ê°åÂè∞
                    </span>
                </div>

                <!-- Label Cards -->
                <div class="qr-label-list" id="qr-label-list">
                    <t t-foreach="tables_data" t-as="item">
                        <div class="qr-label-card"
                             t-att-data-name="item['table'].name"
                             t-att-data-barcode="item['barcode_url']">
                            <div class="qr-label-title">Êâ´Á†ÅÁÇπÈ§ê</div>
                            <img class="qr-label-img" t-att-src="item['barcode_url']" alt="QR Code" crossorigin="anonymous"/>
                            <div class="qr-label-name" t-esc="item['table'].name"/>
                            <div class="qr-label-hint">ËØ∑Êâ´Êèè‰∫åÁª¥Á†ÅÁÇπÈ§ê</div>
                        </div>
                    </t>
                </div>

                <script>
                    /* ===== Size control ===== */
                    function getVals() {
                        return {
                            w: parseInt(document.getElementById('label-w').value) || 62,
                            h: parseInt(document.getElementById('label-h').value) || 62,
                            m: parseInt(document.getElementById('label-m').value) || 3
                        };
                    }

                    function updatePageSize() {
                        var v = getVals();
                        // Update @page
                        document.getElementById('qr-page-style').textContent =
                            '@page { size: ' + v.w + 'mm ' + v.h + 'mm; margin: ' + v.m + 'mm; }';
                        updateCardPreview(v.w, v.h, v.m);
                        // Persist
                        try { localStorage.setItem('qr_label_size', JSON.stringify(v)); } catch(e) {}
                        // Highlight matching preset
                        highlightPreset(v.w, v.h, v.m);
                    }

                    function updateCardPreview(w, h, m) {
                        var contentW = w - 2 * m;
                        var contentH = h - 2 * m;
                        var scale = 3.78;  // 1mm ‚âà 3.78px at 96dpi
                        var cardW = contentW * scale;
                        var cardH = contentH * scale;
                        var qrSize = Math.min(contentW, contentH) * 0.60 * scale;
                        var titleSize = Math.max(10, Math.min(contentW, contentH) * 0.08);
                        var nameSize = Math.max(12, Math.min(contentW, contentH) * 0.14);
                        var hintSize = Math.max(8, Math.min(contentW, contentH) * 0.06);
                        var nameBorder = Math.max(1, Math.min(contentW, contentH) * 0.015);
                        var gap = Math.max(2, contentH * 0.02) + 'px';

                        var cards = document.querySelectorAll('.qr-label-card');
                        for (var i = 0; i &lt; cards.length; i++) {
                            var c = cards[i];
                            c.style.width = cardW + 'px';
                            c.style.height = cardH + 'px';
                            c.style.padding = (m * scale * 0.3) + 'px';
                            c.style.gap = gap;

                            var img = c.querySelector('.qr-label-img');
                            if (img) { img.style.width = qrSize + 'px'; img.style.height = qrSize + 'px'; }

                            var title = c.querySelector('.qr-label-title');
                            if (title) title.style.fontSize = titleSize + 'px';

                            var name = c.querySelector('.qr-label-name');
                            if (name) {
                                name.style.fontSize = nameSize + 'px';
                                name.style.borderWidth = nameBorder + 'px';
                                name.style.padding = '1px ' + Math.max(4, nameSize * 0.3) + 'px';
                            }

                            var hint = c.querySelector('.qr-label-hint');
                            if (hint) hint.style.fontSize = hintSize + 'px';
                        }
                    }

                    function applyPreset(w, h, m) {
                        document.getElementById('label-w').value = w;
                        document.getElementById('label-h').value = h;
                        document.getElementById('label-m').value = m;
                        updatePageSize();
                    }

                    function highlightPreset(w, h, m) {
                        var presets = [[62,62,3],[62,100,3],[62,29,2],[50,50,3]];
                        var btns = document.querySelectorAll('.qr-label-presets button');
                        for (var i = 0; i &lt; btns.length; i++) {
                            var p = presets[i];
                            btns[i].classList.toggle('active', p &amp;&amp; p[0]===w &amp;&amp; p[1]===h &amp;&amp; p[2]===m);
                        }
                    }

                    /* ===== Restore from localStorage ===== */
                    function restoreSettings() {
                        try {
                            var saved = JSON.parse(localStorage.getItem('qr_label_size'));
                            if (saved) {
                                document.getElementById('label-w').value = saved.w || 62;
                                document.getElementById('label-h').value = saved.h || 62;
                                document.getElementById('label-m').value = saved.m || 3;
                            }
                        } catch(e) {}
                        updatePageSize();
                    }

                    /* ===== Export PNG ===== */
                    async function exportImages() {
                        var cards = document.querySelectorAll('.qr-label-card');
                        var v = getVals();
                        var dpi = 300;
                        var mmToPx = dpi / 25.4;
                        var canvasW = Math.round((v.w - 2 * v.m) * mmToPx);
                        var canvasH = Math.round((v.h - 2 * v.m) * mmToPx);
                        var qrSize = Math.round(Math.min(canvasW, canvasH) * 0.60);
                        var titleFontSize = Math.round(Math.min(canvasW, canvasH) * 0.08);
                        var nameFontSize = Math.round(Math.min(canvasW, canvasH) * 0.14);
                        var hintFontSize = Math.round(Math.min(canvasW, canvasH) * 0.06);

                        for (var i = 0; i &lt; cards.length; i++) {
                            var card = cards[i];
                            var name = card.getAttribute('data-name') || ('table_' + i);
                            var imgSrc = card.getAttribute('data-barcode');

                            var canvas = document.createElement('canvas');
                            canvas.width = canvasW;
                            canvas.height = canvasH;
                            var ctx = canvas.getContext('2d');

                            // White background
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(0, 0, canvasW, canvasH);
                            ctx.fillStyle = '#000000';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';

                            // Layout vertical positions
                            var titleY = canvasH * 0.08;
                            var qrY = (canvasH - qrSize) * 0.42;
                            var nameY = qrY + qrSize + canvasH * 0.06;
                            var hintY = canvasH * 0.93;
                            var cx = canvasW / 2;

                            // Title
                            ctx.font = 'bold ' + titleFontSize + 'px Arial, sans-serif';
                            ctx.fillText('Êâ´Á†ÅÁÇπÈ§ê', cx, titleY);

                            // QR image
                            try {
                                var qrImg = await loadImage(imgSrc);
                                ctx.drawImage(qrImg, cx - qrSize/2, qrY, qrSize, qrSize);
                            } catch(e) {
                                ctx.fillStyle = '#ccc';
                                ctx.fillRect(cx - qrSize/2, qrY, qrSize, qrSize);
                                ctx.fillStyle = '#000';
                            }

                            // Name with border
                            ctx.font = 'bold ' + nameFontSize + 'px Arial, sans-serif';
                            var nameMetrics = ctx.measureText(name);
                            var namePadX = nameFontSize * 0.5;
                            var namePadY = nameFontSize * 0.2;
                            var nameBoxW = nameMetrics.width + namePadX * 2;
                            var nameBoxH = nameFontSize + namePadY * 2;
                            ctx.strokeStyle = '#000';
                            ctx.lineWidth = Math.max(2, nameFontSize * 0.08);
                            ctx.strokeRect(cx - nameBoxW/2, nameY - nameBoxH/2, nameBoxW, nameBoxH);
                            ctx.fillText(name, cx, nameY);

                            // Hint
                            ctx.font = hintFontSize + 'px Arial, sans-serif';
                            ctx.fillStyle = '#333';
                            ctx.fillText('ËØ∑Êâ´Êèè‰∫åÁª¥Á†ÅÁÇπÈ§ê', cx, hintY);

                            // Download
                            await downloadCanvas(canvas, 'QR_' + name + '.png');
                        }
                    }

                    function loadImage(src) {
                        return new Promise(function(resolve, reject) {
                            var img = new Image();
                            img.crossOrigin = 'anonymous';
                            img.onload = function() { resolve(img); };
                            img.onerror = reject;
                            img.src = src;
                        });
                    }

                    function downloadCanvas(canvas, filename) {
                        return new Promise(function(resolve) {
                            canvas.toBlob(function(blob) {
                                var a = document.createElement('a');
                                a.href = URL.createObjectURL(blob);
                                a.download = filename;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                setTimeout(function() { URL.revokeObjectURL(a.href); resolve(); }, 100);
                            }, 'image/png');
                        });
                    }

                    /* ===== Init ===== */
                    document.addEventListener('DOMContentLoaded', restoreSettings);
                </script>
            </div>
        </t>
    </template>

    <!--
        V2 Ordering Page Template - Mobile-first Extreme Experience
        Features: Pinned video carousel, Reco rail with PiP, Sticky chips, 2-col grid with stepper
        Use with feature flag: menu_ui_v2=1
    -->
    <template id="ordering_page_v2" name="QR Ordering Page V2">
        <t t-set="html_data" t-value="{}"/>
        <html>
            <head>
                <meta charset="utf-8"/>
                <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
                <meta name="theme-color" content="#ff6b35"/>
                <meta name="format-detection" content="telephone=no"/>
                <title>Êâ´Á†ÅÁÇπÈ§ê</title>
                <link type="text/css" rel="stylesheet" t-att-href="'/qr_ordering/static/src/css/qr_ordering_v2.css?v=' + (build_version or 'dev')"/>
            </head>
            <body>
                <!-- Boot Guard -->
                <div id="qr-boot-guard" style="position: fixed; inset: 0; background: #fff; z-index: 99999; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üçΩÔ∏è</div>
                        <h1 style="font-size: 20px; margin-bottom: 10px; color: #333;">Ê≠£Âú®Âä†ËΩΩ...</h1>
                        <p style="color: #666; font-size: 14px;">Build: <t t-esc="build_version or 'unknown'"/></p>
                    </div>
                </div>

                <!-- Main App Container -->
                <div id="qr-ordering-app"
                     class="qr-page-v2"
                     t-att-data-table-token="table.qr_token"
                     t-att-data-access-token="access_token"
                     t-att-data-table-name="table.name"
                     t-att-data-lang="lang">

                    <!-- Header -->
                    <header class="qr-header-v2">
                        <div>
                            <div class="qr-header-title" t-esc="table.name"/>
                            <div class="qr-header-subtitle">Êâ´Á†ÅÁÇπÈ§ê</div>
                        </div>
                        <select id="qr-lang-select" class="qr-lang-select">
                            <option value="zh_CN" t-att-selected="lang == 'zh_CN' and 'selected' or None">‰∏≠Êñá</option>
                            <option value="ja_JP" t-att-selected="lang == 'ja_JP' and 'selected' or None">Êó•Êú¨Ë™û</option>
                            <option value="en_US" t-att-selected="lang == 'en_US' and 'selected' or None">English</option>
                        </select>
                    </header>

                    <!-- Search Bar -->
                    <div class="qr-search-bar">
                        <input type="text" id="qr-search-input" class="qr-search-input" placeholder="ÊêúÁ¥¢ËèúÂìÅ..."/>
                    </div>

                    <!-- Main Content (scrollable) -->
                    <main class="qr-main-v2">
                        <!-- Pinned Video Carousel -->
                        <section class="qr-pinned-carousel" id="qr-pinned-carousel" style="display:none;">
                            <!-- Rendered by JS -->
                        </section>

                        <!-- Recommendation Rail -->
                        <section class="qr-reco-rail" id="qr-reco-rail" style="display:none;">
                            <!-- Rendered by JS -->
                        </section>

                        <!-- Category Chips (sticky) -->
                        <div class="qr-category-chips" id="qr-category-chips">
                            <button class="qr-chip active" data-category-id="all">ÂÖ®ÈÉ®</button>
                        </div>

                        <!-- Product Grid -->
                        <div class="qr-product-grid" id="qr-product-grid">
                            <div class="qr-loading">
                                <div class="qr-spinner"></div>
                                <p>Âä†ËΩΩ‰∏≠...</p>
                            </div>
                        </div>
                    </main>

                    <!-- Cart Bar (fixed bottom) -->
                    <footer class="qr-cart-bar" id="qr-cart-bar">
                        <div class="qr-cart-summary">
                            <div class="qr-cart-icon">
                                üõí
                                <span class="qr-cart-badge" id="qr-cart-badge">0</span>
                            </div>
                            <span class="qr-cart-total" id="qr-cart-amount">¬•0</span>
                        </div>
                        <button class="qr-cart-btn" id="qr-cart-btn" disabled="disabled">Êü•ÁúãËÆ¢Âçï ‚Üí</button>
                    </footer>

                    <!-- Product Detail Modal -->
                    <div class="qr-modal" id="qr-product-modal">
                        <div class="qr-modal-content">
                            <div class="qr-modal-header">
                                <h2>ËèúÂìÅËØ¶ÊÉÖ</h2>
                                <button class="qr-modal-close">√ó</button>
                            </div>
                            <div class="qr-modal-body">
                                <!-- Rendered by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Cart Modal -->
                    <div class="qr-modal" id="qr-cart-modal">
                        <div class="qr-modal-content">
                            <div class="qr-modal-header">
                                <h2>Ë¥≠Áâ©ËΩ¶</h2>
                                <button class="qr-modal-close">√ó</button>
                            </div>
                            <div class="qr-modal-body">
                                <div class="qr-cart-list" id="qr-cart-list"></div>
                                <div class="qr-cart-note">
                                    <textarea id="qr-cart-note" placeholder="Â§áÊ≥®ÔºàÂøåÂè£„ÄÅÂè£Âë≥Á≠âÔºâ..."></textarea>
                                </div>
                            </div>
                            <div class="qr-cart-actions">
                                <div class="qr-cart-total-row">
                                    <span>ÂêàËÆ°</span>
                                    <span class="qr-cart-total-amount">¬•0</span>
                                </div>
                                <button class="qr-submit-btn" id="qr-submit-order-btn">Êèê‰∫§ËÆ¢Âçï</button>
                            </div>
                        </div>
                    </div>

                    <!-- Order Modal -->
                    <div class="qr-modal" id="qr-order-modal">
                        <div class="qr-modal-content">
                            <div class="qr-modal-header">
                                <h2>ÊàëÁöÑËÆ¢Âçï</h2>
                                <button class="qr-modal-close">√ó</button>
                            </div>
                            <div class="qr-modal-body">
                                <div class="qr-order-list" id="qr-order-list"></div>
                            </div>
                            <div class="qr-order-actions">
                                <button class="qr-add-more-btn" id="qr-add-more-btn">ÁªßÁª≠ÁÇπÈ§ê</button>
                            </div>
                        </div>
                    </div>

                    <!-- Toast -->
                    <div class="qr-toast" id="qr-toast">
                        <span class="qr-toast-message"></span>
                    </div>
                </div>

                <!-- V2 JavaScript -->
                <script type="text/javascript" t-att-src="'/qr_ordering/static/src/js/qr_ordering_v2.js?v=' + (build_version or 'dev')"></script>
            </body>
        </html>
    </template>

</odoo>

