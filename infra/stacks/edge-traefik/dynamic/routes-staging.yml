http:
  routers:
    # CRM API: staging.www.seisei.tokyo/crm-api/* -> Odoo 19
    crm-api-staging:
      rule: "Host(`staging.www.seisei.tokyo`) && PathPrefix(`/crm-api`)"
      service: odoo19-crm
      priority: 200
      entryPoints:
        - websecure
      tls:
        certResolver: cloudflare
      middlewares:
        - crm-strip-prefix
        - crm-odoo19-dbfilter
        - secure-headers@file

    # Seisei Corporate Website Staging
    seisei-www-staging:
      rule: "Host(`staging.seisei.tokyo`) || Host(`staging.www.seisei.tokyo`)"
      service: seisei-www-staging
      entryPoints:
        - websecure
      tls:
        certResolver: cloudflare
      middlewares:
        - secure-headers@file
        - rate-limit@file

    # BizNexus Staging
    biznexus-staging:
      rule: "Host(`staging.biznexus.seisei.tokyo`)"
      service: biznexus-staging
      entryPoints:
        - websecure
      tls:
        certResolver: cloudflare
      middlewares:
        - secure-headers@file
        - rate-limit@file

    # QR Ordering - Session bootstrap for staging QR scans
    odoo-staging-qr-direct-cookie:
      # yamllint disable-line rule:line-length
      rule: "Host(`staging.odoo.seisei.tokyo`) && PathPrefix(`/qr/order/`) && HeadersRegexp(`Cookie`, `qr_bootstrap=1`)"
      service: odoo-staging
      priority: 212
      entryPoints:
        - websecure
      tls:
        certResolver: cloudflare
      middlewares:
        - secure-headers@file
        - rate-limit@file

    odoo-staging-qr-direct:
      # yamllint disable-line rule:line-length
      rule: "Host(`staging.odoo.seisei.tokyo`) && PathPrefix(`/qr/order/`) && Query(`bootstrap`, `1`)"
      service: odoo-staging
      priority: 211
      entryPoints:
        - websecure
      tls:
        certResolver: cloudflare
      middlewares:
        - secure-headers@file
        - rate-limit@file

    odoo-staging-qr-bootstrap:
      rule: "Host(`staging.odoo.seisei.tokyo`) && PathPrefix(`/qr/order/`)"
      service: odoo-staging
      priority: 210
      entryPoints:
        - websecure
      tls:
        certResolver: cloudflare
      middlewares:
        - qr-bootstrap-rewrite
        - secure-headers@file
        - rate-limit@file

    # Odoo Staging - ERP only
    odoo-staging-domain:
      # yamllint disable-line rule:line-length
      rule: "Host(`staging.erp.seisei.tokyo`) || Host(`staging.odoo.seisei.tokyo`)"
      service: odoo-staging
      entryPoints:
        - websecure
      tls:
        certResolver: cloudflare
      middlewares:
        - secure-headers@file
        - rate-limit@file

    # HTTP redirect for all
    staging-http-redirect:
      # yamllint disable-line rule:line-length
      rule: "Host(`staging.seisei.tokyo`) || Host(`staging.www.seisei.tokyo`) || Host(`staging.biznexus.seisei.tokyo`) || Host(`staging.erp.seisei.tokyo`) || Host(`staging.odoo.seisei.tokyo`)"
      service: odoo-staging
      entryPoints:
        - web
      middlewares:
        - https-redirect@file

  middlewares:
    crm-strip-prefix:
      stripPrefix:
        prefixes:
          - "/crm-api"
    qr-bootstrap-rewrite:
      replacePathRegex:
        regex: "^/qr/order/.*"
        replacement: "/qr_ordering/static/qr_bootstrap.html"

    crm-odoo19-dbfilter:
      headers:
        customRequestHeaders:
          X-Odoo-Database: "odoo19"

  services:
    # Odoo 19 CRM API Service (external server)
    odoo19-crm:
      loadBalancer:
        servers:
          - url: "http://13.159.193.191:8069"

    # Seisei Corporate Website Service
    seisei-www-staging:
      loadBalancer:
        servers:
          - url: "http://seisei-www:3000"

    # BizNexus Staging Service
    biznexus-staging:
      loadBalancer:
        servers:
          - url: "http://biznexus-app:9527"

    # Odoo Staging Service
    odoo-staging:
      loadBalancer:
        servers:
          - url: "http://odoo18-staging-web:8069"
