map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 8080;
    server_name _;
    client_max_body_size 20M;

    location = /nginx-health {
        return 200 "OK";
        add_header Content-Type text/plain;
    }

    # Default DB for staging if not provided
    set $dbfilter $arg_db;
    if ($dbfilter = "") {
        set $dbfilter "ten_testodoo";
    }

    # QR order entry: ensure session exists before hitting /qr/order
    location ~ ^/qr/order/ {
        if ($http_cookie !~* "session_id=") {
            rewrite ^/qr/order/(.+)$ /qr/b/$1 last;
        }
        proxy_pass http://odoo18-staging-web:8069;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $dbfilter;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_read_timeout 120s;
        proxy_cookie_flags ~ secure samesite=lax;
    }

    # Bootstrap route (no auth, sets session then redirects to /qr/order)
    location ~ ^/qr/b/ {
        proxy_pass http://odoo18-staging-web:8069;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $dbfilter;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_read_timeout 120s;
        proxy_cookie_flags ~ secure samesite=lax;
    }

    # Short code route
    location ~ ^/qr/s/ {
        proxy_pass http://odoo18-staging-web:8069;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $dbfilter;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_read_timeout 120s;
        proxy_cookie_flags ~ secure samesite=lax;
    }

    # Fallback: proxy any other /qr/* paths
    location ^~ /qr/ {
        proxy_pass http://odoo18-staging-web:8069;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $dbfilter;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_read_timeout 120s;
        proxy_cookie_flags ~ secure samesite=lax;
    }
}
