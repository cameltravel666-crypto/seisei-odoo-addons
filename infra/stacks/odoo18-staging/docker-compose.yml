# =============================================================================
# Seisei Odoo 18 Staging Stack - Production-Parity Mode
# =============================================================================
# STAGING ENVIRONMENT - Mirrors production topology and env structure
# - Images are pre-built by GitHub Actions and pushed to GHCR
# - Staging tests the EXACT same image that will be deployed to production
# - Server ONLY pulls images, NEVER builds locally
# - Uses独立database (staging) to avoid affecting production data
# - Uses the same env var shape as production for true parity
#
# Deployment workflow:
#   1. GitHub Actions builds and pushes image on main branch
#   2. Deploy script creates release snapshot in /srv/releases/stacks/
#   3. Deploy script updates IMAGE_REF in .env with digest
#   4. Deploy script runs: docker compose pull && docker compose up -d
#   5. Run smoke tests to verify the deployment
#   6. If tests pass, deploy same image to production
#
# Required environment variables in .env:
#   IMAGE_REF            - Full image reference with digest (image@sha256:...)
#   DB_PASSWORD          - PostgreSQL password (staging)
#   REDIS_PASSWORD       - Redis password
#   OCR_SERVICE_URL      - Central OCR service URL
#   OCR_SERVICE_KEY      - OCR service API key
#
# External dependencies:
#   - staging-db container running on seisei-odoo-network (OR use separate DB)
#   - edge network must exist for Traefik routing
#
# ⚠️  IMPORTANT: Staging and Production must use the SAME image
# ⚠️  Staging uses immutable image mode (no volume mounts for code)
# ⚠️  Test thoroughly on staging before deploying to production
# =============================================================================

services:
  web:
    # SAME image as production - only configuration differs
    # IMAGE_REF must include full digest (image@sha256:...) for staging deployments
    image: ${IMAGE_REF}
    container_name: odoo18-staging-web
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_started
    environment:
      # Database connection (parity with production env keys)
      - HOST=${DB_HOST:-seisei-db}
      - PORT=${DB_PORT:-5432}
      - USER=${DB_USER:-odoo}
      - PASSWORD=${DB_PASSWORD}
      - PGSSLMODE=${DB_SSLMODE:-require}
      # S3 Storage - use staging bucket or folder
      - SEISEI_S3_BUCKET=${SEISEI_S3_BUCKET}
      - SEISEI_S3_REGION=${SEISEI_S3_REGION:-ap-northeast-1}
      - SEISEI_S3_ACCESS_KEY=${SEISEI_S3_ACCESS_KEY}
      - SEISEI_S3_SECRET_KEY=${SEISEI_S3_SECRET_KEY}
      # OCR Service (shared with production)
      - OCR_SERVICE_URL=${OCR_SERVICE_URL:-http://13.159.193.191:8180/api/v1}
      - OCR_SERVICE_KEY=${OCR_SERVICE_KEY}
    volumes:
      # Data volume - persistent Odoo filestore
      - odoo18-staging-data:/var/lib/odoo
      # Config file - environment-specific settings
      - ./config/odoo.conf:/etc/odoo/odoo.conf:ro
      # Addons path parity with production
      - /opt/seisei-odoo-addons/odoo_modules:/mnt/extra-addons:ro
    networks:
      - seisei-odoo-network
      - odoo18-staging-internal
      - edge
    # NOTE: Do not expose ports directly; use Traefik like production
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8069/web/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 3G  # Slightly less than production
          cpus: '1.5'
    labels:
      - "traefik.enable=true"
      # =================================================================
      # Router: staging.erp.seisei.tokyo
      # =================================================================
      - "traefik.http.routers.odoo18-staging.rule=Host(`staging.erp.seisei.tokyo`)"
      - "traefik.http.routers.odoo18-staging.entrypoints=websecure"
      - "traefik.http.routers.odoo18-staging.tls.certresolver=cloudflare"
      - "traefik.http.routers.odoo18-staging.middlewares=secure-headers@file,rate-limit@file"
      - "traefik.http.routers.odoo18-staging.service=odoo18-staging"
      - "traefik.http.services.odoo18-staging.loadbalancer.server.port=8069"
      # Longpolling / WebSocket
      - "traefik.http.routers.odoo18-staging-lp.rule=Host(`staging.erp.seisei.tokyo`) && (PathPrefix(`/longpolling`) || PathPrefix(`/websocket`))"
      - "traefik.http.routers.odoo18-staging-lp.entrypoints=websecure"
      - "traefik.http.routers.odoo18-staging-lp.tls.certresolver=cloudflare"
      - "traefik.http.routers.odoo18-staging-lp.middlewares=odoo-websocket@file"
      - "traefik.http.routers.odoo18-staging-lp.service=odoo18-staging-lp"
      - "traefik.http.services.odoo18-staging-lp.loadbalancer.server.port=8072"
      - "traefik.http.routers.odoo18-staging-lp.priority=100"

  redis:
    image: redis:7-alpine
    container_name: odoo18-staging-redis
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
    volumes:
      - odoo18-staging-redis:/data
    networks:
      - odoo18-staging-internal
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

volumes:
  odoo18-staging-data:
  odoo18-staging-redis:

networks:
  odoo18-staging-internal:
    driver: bridge
  seisei-odoo-network:
    external: true
  edge:
    external: true
