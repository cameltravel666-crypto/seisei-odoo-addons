# =============================================================================
# Odoo Database Router - Tenant/Admin Split with QR-BFF Integration
# =============================================================================

map $host $tenant_db {
    testodoo.seisei.tokyo                             ten_testodoo;
    demo.nagashiro.top                                ten_testodoo;
    ~^(?<subdomain>[a-z0-9]+)\.erp\.seisei\.tokyo$    ten_$subdomain;
    default                                           "";
}

map $host $is_tenant_subdomain {
    admin.erp.seisei.tokyo      0;
    testodoo.seisei.tokyo       0;
    demo.nagashiro.top          0;
    ~^[a-z0-9]+\.erp\.seisei\.tokyo$  1;
    default                     0;
}

# demo.nagashiro.top should NOT redirect to biznexus (allow Odoo login)
map $host $is_demo_host {
    demo.nagashiro.top          1;
    testodoo.seisei.tokyo       1;
    default                     0;
}

map $http_x_forwarded_proto $real_scheme {
    https   https;
    default $scheme;
}

# For demo hosts, always use HTTPS (they are always behind TLS termination)
map $host $demo_scheme {
    demo.nagashiro.top          https;
    testodoo.seisei.tokyo       https;
    default                     $real_scheme;
}

upstream odoo_tenant {
    server odoo-tenant:8069;
    keepalive 16;
}

upstream odoo_tenant_lp {
    server odoo-tenant:8072;
    keepalive 8;
}

upstream odoo_admin {
    server odoo-admin:8069;
    keepalive 4;
}

upstream odoo_admin_lp {
    server odoo-admin:8072;
    keepalive 2;
}

# =============================================================================
# Admin Server Block - admin.erp.seisei.tokyo
# =============================================================================
server {
    listen 80;
    server_name admin.erp.seisei.tokyo;
    client_max_body_size 50M;

    location = /nginx-health {
        return 200 "OK";
        add_header Content-Type text/plain;
    }

    location ~ ^/(websocket|bus/|longpolling/) {
        proxy_pass http://odoo_admin_lp;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location / {
        proxy_pass http://odoo_admin;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# =============================================================================
# Demo/Test Server Block - demo.nagashiro.top, testodoo.seisei.tokyo
# These domains allow direct Odoo login for testing
# =============================================================================
server {
    listen 80;
    server_name demo.nagashiro.top testodoo.seisei.tokyo;
    client_max_body_size 50M;

    set $final_dbfilter $tenant_db;

    location = /nginx-health {
        return 200 "OK";
        add_header Content-Type text/plain;
    }

    # Block database management
    location ~ ^/web/database/manager {
        return 403 "Database management disabled";
    }

    # WebSocket and Long-polling - port 8072
    location ~ ^/(websocket|bus/|longpolling/) {
        proxy_pass http://odoo_tenant_lp;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $final_dbfilter;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
        # Ensure cookies have Secure flag for HTTPS
        proxy_cookie_flags ~ secure samesite=lax;
    }

    # Static assets
    location ~ ^/web/(static|assets)/ {
        proxy_pass http://odoo_tenant;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $final_dbfilter;
        proxy_cache_valid 200 1d;
    }

    # JSON-RPC and XML-RPC
    location ~ ^/(jsonrpc|xmlrpc) {
        proxy_pass http://odoo_tenant;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $final_dbfilter;
        # Ensure cookies have Secure flag for HTTPS
        proxy_cookie_flags ~ secure samesite=lax;
    }

    # Reports
    location ~ ^/report/ {
        proxy_pass http://odoo_tenant;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $final_dbfilter;
    }

    # POS routes (allow direct access for demo)
    location ~ ^/pos/ {
        proxy_pass http://odoo_tenant;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $final_dbfilter;
        # Ensure cookies have Secure flag for HTTPS
        proxy_cookie_flags ~ secure samesite=lax;
    }

    # QR routes - Return 410 Gone to indicate clients should use qr-bff
    # Customers should never directly access Odoo's QR routes
    location ~ ^/qr/ {
        return 410 '{"error": "QR ordering moved to qr-bff API", "redirect": "https://qr.seisei.tokyo/v1/qr/"}';
        add_header Content-Type application/json;
    }

    # Default - proxy to Odoo tenant (allow login, web access)
    location / {
        proxy_pass http://odoo_tenant;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $final_dbfilter;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        # Ensure cookies have Secure flag for HTTPS
        proxy_cookie_flags ~ secure samesite=lax;
    }
}

# =============================================================================
# Tenant Server Block - *.erp.seisei.tokyo (except admin/demo)
# =============================================================================
server {
    listen 80 default_server;
    server_name _;
    client_max_body_size 50M;

    set $final_dbfilter $tenant_db;

    location = /nginx-health {
        return 200 "OK";
        add_header Content-Type text/plain;
    }

    location ~ ^/web/database/manager {
        return 403 "Database management disabled";
    }

    # Tenant subdomain web login - redirect to biznexus
    location = /web/login {
        if ($is_tenant_subdomain = 1) {
            return 302 https://biznexus.seisei.tokyo/login;
        }
        proxy_pass http://odoo_tenant;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $final_dbfilter;
    }

    # Tenant subdomain root - redirect to biznexus
    location = / {
        if ($is_tenant_subdomain = 1) {
            return 302 https://biznexus.seisei.tokyo;
        }
        proxy_pass http://odoo_tenant;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $final_dbfilter;
    }

    # WebSocket and Long-polling
    location ~ ^/(websocket|bus/|longpolling/) {
        proxy_pass http://odoo_tenant_lp;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $final_dbfilter;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }

    # QR routes - Return 410 Gone (use qr-bff instead)
    location ~ ^/qr/ {
        return 410 '{"error": "QR ordering moved to qr-bff API", "redirect": "https://qr.seisei.tokyo/v1/qr/"}';
        add_header Content-Type application/json;
    }

    # JSON-RPC
    location ~ ^/(jsonrpc|xmlrpc) {
        proxy_pass http://odoo_tenant;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $final_dbfilter;
    }

    # Reports
    location ~ ^/report/ {
        proxy_pass http://odoo_tenant;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $final_dbfilter;
    }

    # Static assets
    location ~ ^/web/(static|assets)/ {
        proxy_pass http://odoo_tenant;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $final_dbfilter;
    }

    # Default - redirect tenants to biznexus, others proxy to Odoo
    location / {
        if ($is_tenant_subdomain = 1) {
            return 302 https://biznexus.seisei.tokyo;
        }
        proxy_pass http://odoo_tenant;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Odoo-dbfilter $final_dbfilter;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
