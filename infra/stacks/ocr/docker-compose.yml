services:
  ocr-service:
    # yamllint disable-line rule:line-length
    image: ghcr.io/cameltravel666-crypto/ocr-service:sha-a52d5aa@sha256:77484f1571054d04934414bb4a7ce867143ef7afee1808df34600e452435bd7d
    container_name: ocr-service
    restart: unless-stopped
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OCR_DATABASE_URL=postgresql://ocr:${OCR_DB_PASSWORD}@ocr-db:5432/ocr_service
      - OCR_SERVICE_KEY=${OCR_SERVICE_KEY}
      - OCR_FREE_QUOTA=${OCR_FREE_QUOTA:-30}
      - OCR_PRICE_PER_IMAGE=${OCR_PRICE_PER_IMAGE:-20}
    ports:
      - "8180:8080"
    depends_on:
      ocr-db:
        condition: service_healthy
    networks:
      - ocr-internal
      - edge
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8080/health')\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      # OCR service - default NOT exposed to public
      # Uncomment to enable public access for debugging
      # - "traefik.enable=true"
      # - "traefik.http.routers.ocr.rule=Host(`ocr.seisei.tokyo`)"
      # - "traefik.http.routers.ocr.entrypoints=websecure"
      # - "traefik.http.routers.ocr.tls.certresolver=cloudflare"
      # - "traefik.http.routers.ocr.middlewares=rate-limit@file"
      # - "traefik.http.services.ocr.loadbalancer.server.port=8080"
      - "traefik.enable=false"

  ocr-db:
    image: postgres:15-alpine
    container_name: ocr-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ocr
      POSTGRES_PASSWORD: ${OCR_DB_PASSWORD}
      POSTGRES_DB: ocr_service
    volumes:
      - ocr-db-data:/var/lib/postgresql/data
    networks:
      - ocr-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ocr"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  ocr-db-data:

networks:
  ocr-internal:
    driver: bridge
  edge:
    external: true
